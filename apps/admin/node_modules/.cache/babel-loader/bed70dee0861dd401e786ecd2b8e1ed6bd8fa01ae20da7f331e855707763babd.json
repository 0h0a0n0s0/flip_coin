{"ast":null,"code":"import { ElMessage, ElMessageBox } from 'element-plus';\nexport default {\n  name: 'UserLevelsView',\n  data() {\n    // (辅助验证函数)\n    const validateNumeric = (rule, value, callback) => {\n      if (value === null || value === undefined || value === '') {\n        callback(new Error('此栏位不能为空'));\n      } else if (typeof value !== 'number' || value < 0) {\n        callback(new Error('必须是非负数'));\n      } else {\n        callback();\n      }\n    };\n    const validateInteger = (rule, value, callback) => {\n      if (value === null || value === undefined || value === '') {\n        callback(new Error('此栏位不能为空'));\n      } else if (typeof value !== 'number' || value < 0 || !Number.isInteger(value)) {\n        callback(new Error('必须是非负整数'));\n      } else {\n        callback();\n      }\n    };\n    return {\n      loading: true,\n      submitLoading: false,\n      tableData: [],\n      // { level, name, ... }\n      dialogVisible: false,\n      dialogTitle: '',\n      isEditMode: false,\n      // 区分新增或编辑\n      levelForm: {\n        // 表单数据\n        level: null,\n        name: '',\n        max_bet_amount: null,\n        required_bets_for_upgrade: null,\n        min_bet_amount_for_upgrade: null,\n        upgrade_reward_amount: null\n      },\n      formRules: {\n        // 表单验证规則\n        level: [{\n          required: true,\n          message: '等级不能为空',\n          trigger: 'blur'\n        }, {\n          type: 'integer',\n          min: 1,\n          message: '等级必须是正整数',\n          trigger: 'blur'\n        }],\n        name: [{\n          required: true,\n          message: '等级名称不能为空',\n          trigger: 'blur'\n        }],\n        max_bet_amount: [{\n          required: true,\n          validator: validateNumeric,\n          trigger: 'blur'\n        }],\n        required_bets_for_upgrade: [{\n          required: true,\n          validator: validateInteger,\n          trigger: 'blur'\n        }],\n        min_bet_amount_for_upgrade: [{\n          required: true,\n          validator: validateNumeric,\n          trigger: 'blur'\n        }],\n        upgrade_reward_amount: [{\n          required: true,\n          validator: validateNumeric,\n          trigger: 'blur'\n        }]\n      }\n    };\n  },\n  computed: {\n    // 计算建议的下一個等级\n    nextLevel() {\n      if (!this.tableData || this.tableData.length === 0) return 1;\n      // 找到目前最大的等级 + 1\n      const maxLevel = Math.max(...this.tableData.map(item => item.level));\n      return maxLevel + 1;\n    }\n  },\n  created() {\n    this.fetchLevels();\n  },\n  methods: {\n    async fetchLevels() {\n      this.loading = true;\n      try {\n        this.tableData = await this.$api.getUserLevels();\n      } catch (error) {\n        console.error('Failed to fetch user levels:', error);\n      } finally {\n        this.loading = false;\n      }\n    },\n    handleAdd() {\n      this.dialogTitle = '新增用户等级';\n      this.isEditMode = false;\n      // 重置表单，建议等级填入 nextLevel\n      Object.assign(this.levelForm, {\n        level: this.nextLevel,\n        name: `Level ${this.nextLevel}`,\n        max_bet_amount: null,\n        required_bets_for_upgrade: null,\n        min_bet_amount_for_upgrade: null,\n        upgrade_reward_amount: null\n      });\n      this.dialogVisible = true;\n      this.$nextTick(() => {\n        this.$refs.levelFormRef?.clearValidate();\n      });\n    },\n    handleEdit(row) {\n      this.dialogTitle = `编辑等级 ${row.level}`;\n      this.isEditMode = true;\n      // 将 row 的数据复制到表单 (需要确保後端返回的数字类型正确)\n      Object.assign(this.levelForm, {\n        level: row.level,\n        name: row.name,\n        // (後端返回的是 string 或 number? 我们假设是 string，需要 parseFloat)\n        max_bet_amount: parseFloat(row.max_bet_amount) || 0,\n        required_bets_for_upgrade: parseInt(row.required_bets_for_upgrade) || 0,\n        min_bet_amount_for_upgrade: parseFloat(row.min_bet_amount_for_upgrade) || 0,\n        upgrade_reward_amount: parseFloat(row.upgrade_reward_amount) || 0\n      });\n      this.dialogVisible = true;\n      this.$nextTick(() => {\n        this.$refs.levelFormRef?.clearValidate();\n      });\n    },\n    async handleSubmit() {\n      const formEl = this.$refs.levelFormRef;\n      if (!formEl) return;\n      await formEl.validate(async valid => {\n        if (valid) {\n          this.submitLoading = true;\n          try {\n            // 准备提交的数据 (移除 level，因为 level 在 URL 中)\n            const dataToSubmit = {\n              ...this.levelForm\n            };\n            if (this.isEditMode) {\n              // delete dataToSubmit.level; // PUT API URL 中已包含 level\n              await this.$api.updateUserLevel(this.levelForm.level, dataToSubmit);\n              ElMessage.success('等级更新成功');\n            } else {\n              await this.$api.addUserLevel(dataToSubmit);\n              ElMessage.success('等级新增成功');\n            }\n            this.dialogVisible = false;\n            await this.fetchLevels(); // 刷新列表\n          } catch (error) {\n            console.error('Failed to submit user level:', error);\n          } finally {\n            this.submitLoading = false;\n          }\n        } else {\n          return false;\n        }\n      });\n    },\n    handleDelete(row) {\n      ElMessageBox.confirm(`确定要刪除等级 ${row.level} (${row.name}) 吗？`, '警告', {\n        confirmButtonText: '确定刪除',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(async () => {\n        try {\n          await this.$api.deleteUserLevel(row.level);\n          ElMessage.success('等级刪除成功');\n          await this.fetchLevels(); // 刷新列表\n        } catch (error) {\n          console.error('Failed to delete user level:', error);\n        }\n      }).catch(() => {});\n    },\n    formatCurrency(value) {\n      if (value === null || value === undefined) return '';\n      if (typeof value === 'string') {\n        try {\n          value = parseFloat(value);\n        } catch (e) {\n          return 'N/A';\n        }\n      }\n      if (typeof value !== 'number') return 'N/A';\n      return value.toFixed(8);\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}