{"ast":null,"code":"// 档案: admin-ui/src/utils/request.js (新档案)\n\nimport axios from 'axios';\nimport { ElMessage } from 'element-plus';\n\n// 建立 Axios 實例\nconst service = axios.create({\n  baseURL: '/',\n  timeout: 10000\n});\n\n// (新增) 用於緩存 IP，避免每次請求都查詢\nlet cachedRealIp = null;\n\n// (新增) 獲取真實 IP 的異步函數\nasync function getClientIp() {\n  if (cachedRealIp) return cachedRealIp;\n  try {\n    // 使用 ipify 獲取真實公網 IP\n    const response = await fetch('https://api.ipify.org?format=json');\n    if (response.ok) {\n      const data = await response.json();\n      cachedRealIp = data.ip;\n      return cachedRealIp;\n    }\n  } catch (e) {\n    console.warn('[Frontend] Failed to fetch real IP:', e);\n  }\n  return null;\n}\n\n// 请求拦截器 (Request Interceptor)\nservice.interceptors.request.use(async config => {\n  // (注意：這裡加上 async)\n  const token = localStorage.getItem('admin_token');\n  if (token) {\n    config.headers['Authorization'] = `Bearer ${token}`;\n  }\n\n  // (新增) 注入真實 IP 到 Header\n  const realIp = await getClientIp();\n  if (realIp) {\n    config.headers['X-Client-Real-IP'] = realIp;\n  }\n  return config;\n}, error => {\n  console.error('Request error:', error);\n  return Promise.reject(error);\n});\n\n// 回应拦截器 (Response Interceptor)\nservice.interceptors.response.use(response => {\n  return response.data;\n}, error => {\n  console.error('Response error:', error.response);\n  let message = '请求失败';\n  if (error.response) {\n    if (error.response.data && error.response.data.error) {\n      message = error.response.data.error;\n    } else {\n      message = `错误 ${error.response.status}: ${error.response.statusText}`;\n    }\n\n    // (★★★ 关键修复：区分 401 来源 ★★★)\n    if (error.response.status === 401) {\n      const originalRequestUrl = error.config.url;\n\n      // 1. 如果是「登入 API」本身返回 401，代表帐号密码错误\n      if (originalRequestUrl.includes('/api/admin/login')) {\n        // (不需要做任何事，让错误继续往下传遞到 Login.vue 的 catch 块)\n        // (ElMessage.error 会在下面统一处理)\n      } else {\n        // 2. 如果是其他 API (例如 /stats) 返回 401，代表 Token 过期\n        ElMessage.error('Token 已过期或無效，请重新登入。');\n        localStorage.removeItem('admin_token');\n\n        // (如果是 /admin/ 以外的路径，才跳转)\n        if (!window.location.pathname.startsWith('/admin/login')) {\n          window.location.href = '/admin/login';\n        }\n        return new Promise(() => {}); // 中断 API 链\n      }\n    }\n  }\n\n  // (统一显示 400 业务错误、500 伺服器错误，或登入失败的 401 错误)\n  ElMessage.error(message);\n  return Promise.reject(error);\n});\nexport default service;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}