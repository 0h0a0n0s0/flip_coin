{"ast":null,"code":"// 档案: admin-ui/src/utils/request.js (新档案)\n\nimport axios from 'axios';\nimport { ElMessage } from 'element-plus';\n\n// 建立 Axios 實例\nconst service = axios.create({\n  baseURL: '/',\n  timeout: 10000\n});\n\n// 获取真实IP的函数（使用第三方API）\nasync function getClientRealIp() {\n  try {\n    // 尝试从localStorage获取缓存的IP\n    const cachedIp = localStorage.getItem('client_real_ip');\n    const cachedTime = localStorage.getItem('client_real_ip_time');\n\n    // 如果缓存存在且未过期（5分钟），直接返回\n    if (cachedIp && cachedTime && Date.now() - parseInt(cachedTime) < 5 * 60 * 1000) {\n      return cachedIp;\n    }\n\n    // 通过第三方API获取真实IP\n    const response = await fetch('https://api.ipify.org?format=json', {\n      method: 'GET',\n      timeout: 3000\n    });\n    if (response.ok) {\n      const data = await response.json();\n      const ip = data.ip;\n\n      // 缓存IP和时间戳\n      if (ip) {\n        localStorage.setItem('client_real_ip', ip);\n        localStorage.setItem('client_real_ip_time', Date.now().toString());\n        return ip;\n      }\n    }\n  } catch (error) {\n    console.warn('[Request] Failed to get client real IP:', error);\n    // 如果获取失败，返回缓存的IP（如果有）\n    return localStorage.getItem('client_real_ip') || null;\n  }\n  return null;\n}\n\n// 请求拦截器 (Request Interceptor)\nservice.interceptors.request.use(async config => {\n  const token = localStorage.getItem('admin_token');\n  if (token) {\n    config.headers['Authorization'] = `Bearer ${token}`;\n  }\n\n  // (★★★ 新增：获取并发送真实IP ★★★)\n  // 对于登录请求，获取真实IP并添加到请求头\n  // 使用Promise.race确保不会因为获取IP超时而阻塞登录\n  if (config.url && config.url.includes('/api/admin/login')) {\n    try {\n      // 设置3秒超时，避免阻塞登录\n      const ipPromise = getClientRealIp();\n      const timeoutPromise = new Promise(resolve => setTimeout(() => resolve(null), 3000));\n      const realIp = await Promise.race([ipPromise, timeoutPromise]);\n      if (realIp) {\n        config.headers['X-Client-Real-IP'] = realIp;\n      }\n    } catch (error) {\n      // 获取IP失败不影响登录流程\n      console.warn('[Request] Failed to get real IP for login:', error);\n    }\n  }\n  return config;\n}, error => {\n  console.error('Request error:', error);\n  return Promise.reject(error);\n});\n\n// 回应拦截器 (Response Interceptor)\nservice.interceptors.response.use(response => {\n  return response.data;\n}, error => {\n  console.error('Response error:', error.response);\n  let message = '请求失败';\n  if (error.response) {\n    if (error.response.data && error.response.data.error) {\n      message = error.response.data.error;\n    } else {\n      message = `错误 ${error.response.status}: ${error.response.statusText}`;\n    }\n\n    // (★★★ 关键修复：区分 401 来源 ★★★)\n    if (error.response.status === 401) {\n      const originalRequestUrl = error.config.url;\n\n      // 1. 如果是「登入 API」本身返回 401，代表帐号密码错误\n      if (originalRequestUrl.includes('/api/admin/login')) {\n        // (不需要做任何事，让错误继续往下传遞到 Login.vue 的 catch 块)\n        // (ElMessage.error 会在下面统一处理)\n      } else {\n        // 2. 如果是其他 API (例如 /stats) 返回 401，代表 Token 过期\n        ElMessage.error('Token 已过期或無效，请重新登入。');\n        localStorage.removeItem('admin_token');\n\n        // (如果是 /admin/ 以外的路径，才跳转)\n        if (!window.location.pathname.startsWith('/admin/login')) {\n          window.location.href = '/admin/login';\n        }\n        return new Promise(() => {}); // 中断 API 链\n      }\n    }\n  }\n\n  // (统一显示 400 业务错误、500 伺服器错误，或登入失败的 401 错误)\n  ElMessage.error(message);\n  return Promise.reject(error);\n});\nexport default service;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}