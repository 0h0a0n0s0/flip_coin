{"ast":null,"code":"// ( ... <script> 标签内的逻辑保持不变 ... )\nimport { ElMessage } from 'element-plus';\nexport default {\n  name: 'UserManagementView',\n  data() {\n    return {\n      loading: false,\n      tableData: [],\n      totalItems: 0,\n      pagination: {\n        page: 1,\n        limit: 10\n      },\n      searchParams: {\n        userId: '',\n        username: '',\n        dateRange: null,\n        nickname: '',\n        status: '',\n        inviteCode: '',\n        referrerCode: '',\n        lastLoginIp: '',\n        activityDateRange: null\n      },\n      editDialogVisible: false,\n      editLoading: false,\n      editForm: {\n        currentUser: null,\n        nickname: '',\n        level: 1,\n        referrer_code: '',\n        balance: 0\n      },\n      editFormRules: {\n        nickname: [{\n          max: 50,\n          message: '昵称长度不能超过 50 个字符',\n          trigger: 'blur'\n        }],\n        level: [{\n          required: true,\n          message: '等级不能为空'\n        }, {\n          type: 'integer',\n          min: 1,\n          message: '等级必须是正整数',\n          trigger: 'blur'\n        }],\n        referrer_code: [{\n          max: 8,\n          message: '邀请码长度不能超过 8 个字符',\n          trigger: 'blur'\n        }],\n        balance: [{\n          required: true,\n          message: '余额不能为空'\n        }, {\n          type: 'number',\n          min: 0,\n          message: '余额必须是非负数',\n          trigger: 'blur'\n        }]\n      },\n      referralDialogVisible: false,\n      referralData: {\n        loading: false,\n        inviteCode: '',\n        list: []\n      }\n    };\n  },\n  created() {\n    this.fetchUsers();\n  },\n  methods: {\n    async fetchUsers() {\n      if (this.loading) return;\n      this.loading = true;\n      try {\n        const params = {\n          ...this.pagination,\n          userId: this.searchParams.userId || undefined,\n          username: this.searchParams.username || undefined,\n          dateRange: this.searchParams.dateRange ? JSON.stringify(this.searchParams.dateRange) : undefined,\n          nickname: this.searchParams.nickname || undefined,\n          status: this.searchParams.status || undefined,\n          inviteCode: this.searchParams.inviteCode || undefined,\n          referrerCode: this.searchParams.referrerCode || undefined,\n          lastLoginIp: this.searchParams.lastLoginIp || undefined,\n          activityDateRange: this.searchParams.activityDateRange ? JSON.stringify(this.searchParams.activityDateRange) : undefined\n        };\n        const response = await this.$api.getUsers(params);\n        this.tableData = response.list;\n        this.totalItems = response.total;\n      } catch (error) {\n        console.error('Failed to fetch users:', error);\n      } finally {\n        this.loading = false;\n      }\n    },\n    async handleStatusChange(row) {\n      const newStatus = row.status;\n      const oldStatus = newStatus === 'active' ? 'banned' : 'active';\n      try {\n        await this.$api.updateUserStatus(row.id, newStatus);\n        ElMessage.success(`用户 ${row.user_id} 狀态已更新为 ${newStatus}`);\n      } catch (error) {\n        console.error('Failed to update status:', error);\n        row.status = oldStatus;\n      }\n    },\n    handleSearch() {\n      this.pagination.page = 1;\n      this.fetchUsers();\n    },\n    handleSizeChange(newLimit) {\n      this.pagination.limit = newLimit;\n      this.pagination.page = 1;\n      this.fetchUsers();\n    },\n    handlePageChange(newPage) {\n      this.pagination.page = newPage;\n      this.fetchUsers();\n    },\n    formatDateTime(isoString) {\n      if (!isoString) return '';\n      try {\n        return new Date(isoString).toLocaleString('zh-TW', {\n          timeZone: 'Asia/Taipei'\n        });\n      } catch (e) {\n        return isoString;\n      }\n    },\n    formatCurrency(value) {\n      if (value === null || value === undefined) return '0.00';\n      try {\n        const num = parseFloat(value);\n        if (isNaN(num)) return '0.00';\n        return num.toFixed(2);\n      } catch (e) {\n        return '0.00';\n      }\n    },\n    handleEdit(row) {\n      this.editForm.currentUser = row;\n      this.editForm.nickname = row.nickname || '';\n      this.editForm.level = row.level;\n      this.editForm.referrer_code = row.referrer_code || '';\n      this.editForm.balance = parseFloat(row.balance) || 0;\n      this.editDialogVisible = true;\n      this.$nextTick(() => {\n        this.$refs.editFormRef?.clearValidate();\n      });\n    },\n    async handleSubmitEdit() {\n      const formEl = this.$refs.editFormRef;\n      if (!formEl) return;\n      await formEl.validate(async valid => {\n        if (valid) {\n          this.editLoading = true;\n          try {\n            const dataToSubmit = {\n              nickname: this.editForm.nickname,\n              level: this.editForm.level,\n              referrer_code: this.editForm.referrer_code || null,\n              balance: this.editForm.balance\n            };\n            await this.$api.updateUser(this.editForm.currentUser.id, dataToSubmit);\n            ElMessage.success('用户资料更新成功');\n            this.editDialogVisible = false;\n            await this.fetchUsers();\n          } catch (error) {\n            console.error('Failed to update user:', error);\n          } finally {\n            this.editLoading = false;\n          }\n        } else {\n          return false;\n        }\n      });\n    },\n    async handleViewReferrals(row) {\n      this.referralData.inviteCode = row.invite_code;\n      this.referralData.list = [];\n      this.referralData.loading = true;\n      this.referralDialogVisible = true;\n      try {\n        const referrals = await this.$api.getReferrals(row.invite_code);\n        this.referralData.list = referrals;\n      } catch (error) {\n        console.error('Failed to fetch referrals:', error);\n        ElMessage.error('载入推薦列表失败');\n      } finally {\n        this.referralData.loading = false;\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}