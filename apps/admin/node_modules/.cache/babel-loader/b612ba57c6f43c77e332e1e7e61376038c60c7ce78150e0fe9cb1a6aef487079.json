{"ast":null,"code":"import { ElMessage } from 'element-plus';\nexport default {\n  name: 'GameParametersView',\n  data() {\n    return {\n      loading: true,\n      submitLoading: false,\n      activeTab: 'Game',\n      // 预设显示哪個 tab\n\n      // (★★★ v8.1 修改：表单结构改为分组 ★★★)\n      formGroups: {\n        // (预设结构，防止渲染错误)\n        Game: null,\n        Finance: null,\n        RiskControl: null,\n        General: null\n      },\n      // (保留原始 API 回传，用于比对)\n      originalSettings: {}\n    };\n  },\n  created() {\n    this.fetchSettings();\n  },\n  methods: {\n    // (★★★ v8.1 新增：数字验证 ★★★)\n    validateNumeric(rule, value, callback) {\n      // (注意：value 現在是 { value: '...', description: '...' } 中的 value)\n      const num = parseFloat(value);\n      if (isNaN(num) || num < 0) {\n        callback(new Error('必须是非负数'));\n      } else {\n        callback();\n      }\n    },\n    // (★★★ v8.1 新增：整数验证 ★★★)\n    validateInteger(rule, value, callback) {\n      const num = parseFloat(value);\n      if (isNaN(num) || num <= 0 || !Number.isInteger(num)) {\n        callback(new Error('必须是正整数'));\n      } else {\n        callback();\n      }\n    },\n    async fetchSettings() {\n      this.loading = true;\n      try {\n        // (★★★ v8.1 修改：API 現在返回分组的物件 ★★★)\n        const settingsByCategory = await this.$api.getSettings();\n\n        // (储存原始值，用于比对)\n        this.originalSettings = JSON.parse(JSON.stringify(settingsByCategory));\n        // (赋值给表单)\n        this.formGroups = settingsByCategory;\n\n        // (检查预设 tab 是否有内容)\n        if (!this.formGroups[this.activeTab]) {\n          // 如果 'Game' 没内容，切换到 'Finance'\n          if (this.formGroups.Finance) this.activeTab = 'Finance';else if (this.formGroups.RiskControl) this.activeTab = 'RiskControl';else if (this.formGroups.General) this.activeTab = 'General';\n        }\n      } catch (error) {\n        console.error('Failed to fetch settings:', error);\n        ElMessage.error('载入设定失败');\n      } finally {\n        this.loading = false;\n      }\n    },\n    // (★★★ v8.1 修改：按分组提交 ★★★)\n    async handleSubmit(groupName) {\n      const formRefName = `${groupName.toLowerCase()}FormRef`;\n      const formEl = this.$refs[formRefName];\n      if (!formEl) return;\n      await formEl.validate(async valid => {\n        if (valid) {\n          this.submitLoading = true;\n          const settingsToUpdate = this.formGroups[groupName];\n          const originalGroupSettings = this.originalSettings[groupName] || {};\n          try {\n            const updatePromises = [];\n\n            // (只提交有变动的 key)\n            for (const key in settingsToUpdate) {\n              if (settingsToUpdate[key].value !== originalGroupSettings[key]?.value) {\n                updatePromises.push(this.$api.updateSetting(key, settingsToUpdate[key].value));\n              }\n            }\n            if (updatePromises.length === 0) {\n              ElMessage.info('设定未变动');\n              this.submitLoading = false;\n              return;\n            }\n            await Promise.all(updatePromises);\n            ElMessage.success('设定储存成功！');\n\n            // (储存成功後重新载入所有设定，以更新 originalSettings)\n            await this.fetchSettings();\n          } catch (error) {\n            console.error('Failed to save settings:', error);\n            ElMessage.error('储存设定失败');\n          } finally {\n            this.submitLoading = false;\n          }\n        } else {\n          ElMessage.error('表单验证失败');\n          return false;\n        }\n      });\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}