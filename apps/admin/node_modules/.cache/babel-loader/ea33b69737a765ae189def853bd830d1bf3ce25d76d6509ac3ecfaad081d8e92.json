{"ast":null,"code":"// 档案: admin-ui/src/utils/request.js\n\nimport axios from 'axios';\nimport { ElMessage, ElMessageBox } from 'element-plus';\n\n// 建立 Axios 實例\nconst service = axios.create({\n  baseURL: '/',\n  timeout: 10000\n});\n\n// 缓存 IP\nlet cachedRealIp = localStorage.getItem('debug_real_ip') || null;\n\n// 定义多个 IP 查询源 (Failover)\nconst IP_SERVICES = [{\n  url: 'https://api.ipify.org?format=json',\n  key: 'ip'\n}, {\n  url: 'https://api.seeip.org/jsonip',\n  key: 'ip'\n}, {\n  url: 'https://api.my-ip.io/ip.json',\n  key: 'ip'\n}, {\n  url: 'https://ipapi.co/json/',\n  key: 'ip'\n}];\n\n// (强力版) 获取真实 IP\nasync function getClientIp() {\n  if (cachedRealIp) return cachedRealIp;\n  console.log('[Frontend] Auto-detecting IP...');\n  for (const service of IP_SERVICES) {\n    try {\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 3000); // 3秒超时\n\n      const response = await fetch(service.url, {\n        signal: controller.signal\n      });\n      clearTimeout(timeoutId);\n      if (response.ok) {\n        const data = await response.json();\n        const ip = data[service.key];\n        if (ip) {\n          console.log(`[Frontend] Detected IP via ${service.url}: ${ip}`);\n          cachedRealIp = ip;\n          // 缓存到 Session Storage 避免刷新丢失\n          sessionStorage.setItem('cached_real_ip', ip);\n          return ip;\n        }\n      }\n    } catch (e) {\n      console.warn(`[Frontend] Source failed: ${service.url}`, e.message);\n    }\n  }\n\n  // 如果所有自动源都失败，尝试从 Session 读取\n  const sessionIp = sessionStorage.getItem('cached_real_ip');\n  if (sessionIp) return sessionIp;\n  console.error('[Frontend] All IP services failed!');\n  return null;\n}\n\n// 请求拦截器\nservice.interceptors.request.use(async config => {\n  const token = localStorage.getItem('admin_token');\n  if (token) {\n    config.headers['Authorization'] = `Bearer ${token}`;\n  }\n\n  // 1. 尝试获取 IP\n  let realIp = await getClientIp();\n\n  // 2. (最后防线) 如果自动获取失败，尝试使用手动覆盖的 IP\n  if (!realIp) {\n    // 您可以在控制台输入 localStorage.setItem('FORCE_IP', '125.229.37.48') 来强制修复\n    realIp = localStorage.getItem('FORCE_IP');\n    if (realIp) console.log('[Frontend] Using FORCED IP:', realIp);\n  }\n\n  // 3. 注入 Header\n  if (realIp) {\n    config.headers['X-Client-Real-IP'] = realIp;\n  }\n  return config;\n}, error => {\n  console.error('Request error:', error);\n  return Promise.reject(error);\n});\n\n// 响应拦截器\nservice.interceptors.response.use(response => {\n  return response.data;\n}, error => {\n  console.error('Response error:', error.response);\n  let message = '请求失败';\n  if (error.response) {\n    // 特殊处理 403 IP 阻挡\n    if (error.response.status === 403 && error.response.data?.error?.includes('Access Denied')) {\n      // 如果是因为 IP 问题被挡，且这是第一次，提示用户手动输入\n      if (!localStorage.getItem('FORCE_IP')) {\n        ElMessageBox.prompt('无法自动检测您的 IP (可能被防火墙拦截)。请输入您的真实 IP 以继续：', 'IP 检测失败', {\n          confirmButtonText: '保存并重试',\n          inputPattern: /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,\n          inputErrorMessage: 'IP 格式不正确'\n        }).then(({\n          value\n        }) => {\n          localStorage.setItem('FORCE_IP', value);\n          location.reload(); // 刷新页面重试\n        }).catch(() => {});\n        return Promise.reject(error);\n      }\n    }\n    if (error.response.data && error.response.data.error) {\n      message = error.response.data.error;\n    }\n    if (error.response.status === 401) {\n      const url = error.config.url;\n      if (!url.includes('/login')) {\n        localStorage.removeItem('admin_token');\n        location.href = '/admin/login';\n        return Promise.reject(error);\n      }\n    }\n  }\n  ElMessage.error(message);\n  return Promise.reject(error);\n});\nexport default service;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}