{"ast":null,"code":"// 档案: admin-ui/src/router/index.js (★★★ v7.4 修正版 ★★★)\n\nimport { createRouter, createWebHistory } from 'vue-router';\nimport { jwtDecode } from 'jwt-decode';\nimport { ElMessage } from 'element-plus';\nimport permissionsStore from '@/store'; // (★★★ 1. 导入 Store ★★★)\n\n// (导入所有组件)\nimport Login from '../views/Login.vue';\nimport Layout from '../views/Layout.vue';\nimport Dashboard from '../views/Dashboard.vue';\nimport UserManagement from '../views/UserManagement.vue';\nimport UserDepositAddresses from '../views/UserDepositAddresses.vue';\nimport BetManagement from '../views/BetManagement.vue';\nimport ReportManagement from '../views/ReportManagement.vue';\nimport WalletMonitoring from '../views/WalletMonitoring.vue';\nimport WithdrawalReview from '../views/finance/WithdrawalReview.vue';\nimport DepositHistory from '../views/finance/DepositHistory.vue';\nimport GameParameters from '../views/settings/GameParameters.vue';\nimport SameIpMonitor from '../views/risk/SameIpMonitor.vue';\nimport BlockedRegions from '../views/settings/BlockedRegions.vue';\nimport UserLevels from '../views/settings/UserLevels.vue';\nimport AccountManagement from '../views/admin/AccountManagement.vue';\nimport Permissions from '../views/admin/Permissions.vue';\nimport IpWhitelist from '../views/admin/IpWhitelist.vue';\nimport AuditLogs from '../views/admin/AuditLogs.vue';\nimport CollectionLogs from '../views/CollectionLogs.vue';\nimport LoginQuery from '../views/LoginQuery.vue';\nconst routes = [{\n  path: '/login',\n  name: 'Login',\n  component: Login\n}, {\n  path: '/',\n  component: Layout,\n  redirect: '/dashboard',\n  children: [\n  // (★★★ 2. 添加 meta.permission 用于路由守卫 ★★★)\n  {\n    path: 'dashboard',\n    name: 'Dashboard',\n    component: Dashboard,\n    meta: {\n      requiresAuth: true,\n      permission: 'dashboard:read'\n    }\n  }, {\n    path: 'users',\n    name: 'UserManagement',\n    component: UserManagement,\n    meta: {\n      requiresAuth: true,\n      permission: 'users:read'\n    }\n  }, {\n    path: 'users/deposit-addresses',\n    name: 'UserDepositAddresses',\n    component: UserDepositAddresses,\n    meta: {\n      requiresAuth: true,\n      permission: 'users_addresses:read'\n    }\n  }, {\n    path: 'users/login-query',\n    name: 'LoginQuery',\n    component: LoginQuery,\n    meta: {\n      requiresAuth: true,\n      permission: 'users:read'\n    }\n  }, {\n    path: 'bets',\n    name: 'BetManagement',\n    component: BetManagement,\n    meta: {\n      requiresAuth: true,\n      permission: 'bets:read'\n    }\n  }, {\n    path: 'reports',\n    name: 'ReportManagement',\n    component: ReportManagement,\n    meta: {\n      requiresAuth: true,\n      permission: 'reports:read'\n    }\n  }, {\n    path: 'collection-logs',\n    name: 'CollectionLogs',\n    component: CollectionLogs,\n    meta: {\n      requiresAuth: true,\n      permission: 'reports:read'\n    }\n  }, {\n    path: 'wallet-monitoring',\n    name: 'WalletMonitoring',\n    component: WalletMonitoring,\n    meta: {\n      requiresAuth: true,\n      permission: 'wallets:read'\n    }\n  }, {\n    path: 'finance/withdrawals',\n    name: 'WithdrawalReview',\n    component: WithdrawalReview,\n    meta: {\n      requiresAuth: true,\n      permission: 'withdrawals:read'\n    }\n  }, {\n    path: 'finance/deposits',\n    name: 'DepositHistory',\n    component: DepositHistory,\n    meta: {\n      requiresAuth: true,\n      permission: 'deposits:read'\n    }\n  }, {\n    path: '/settings/game-parameters',\n    name: 'GameParameters',\n    component: GameParameters,\n    meta: {\n      requiresAuth: true,\n      permission: 'settings_game:read'\n    }\n  }, {\n    path: '/settings/blocked-regions',\n    name: 'BlockedRegions',\n    component: BlockedRegions,\n    meta: {\n      requiresAuth: true,\n      permission: 'settings_regions:read'\n    }\n  }, {\n    path: '/settings/user-levels',\n    name: 'UserLevels',\n    component: UserLevels,\n    meta: {\n      requiresAuth: true,\n      permission: 'settings_levels:read'\n    }\n  }, {\n    path: '/risk/same-ip',\n    name: 'SameIpMonitor',\n    component: SameIpMonitor,\n    meta: {\n      requiresAuth: true,\n      permission: 'users:update_status'\n    }\n  }, {\n    path: '/admin/accounts',\n    name: 'AccountManagement',\n    component: AccountManagement,\n    meta: {\n      requiresAuth: true,\n      permission: 'admin_accounts:read'\n    }\n  }, {\n    path: '/admin/permissions',\n    name: 'Permissions',\n    component: Permissions,\n    meta: {\n      requiresAuth: true,\n      permission: 'admin_permissions:read'\n    }\n  }, {\n    path: '/admin/ip-whitelist',\n    name: 'IpWhitelist',\n    component: IpWhitelist,\n    meta: {\n      requiresAuth: true,\n      permission: 'admin_ip_whitelist:read'\n    }\n  }, {\n    path: '/admin/audit-logs',\n    name: 'AuditLogs',\n    component: AuditLogs,\n    meta: {\n      requiresAuth: true,\n      permission: 'admin_permissions:read'\n    }\n  }]\n}];\nconst router = createRouter({\n  history: createWebHistory('/admin/'),\n  routes\n});\n\n// (★★★ 3. 升级路由守卫 ★★★)\nrouter.beforeEach(async (to, from, next) => {\n  const token = localStorage.getItem('admin_token');\n  if (to.meta.requiresAuth) {\n    if (token) {\n      try {\n        const decoded = jwtDecode(token);\n        if (decoded.exp * 1000 < Date.now()) throw new Error('Token expired');\n\n        // (★★★ 4. 检查 Store 是否已加载 ★★★)\n        if (!permissionsStore.isLoaded) {\n          console.log('[Router Guard] Token valid, loading permissions...');\n          await permissionsStore.loadPermissions();\n        }\n\n        // (★★★ 5. 检查路由权限 ★★★)\n        const requiredPermission = to.meta.permission;\n        if (requiredPermission) {\n          const [resource, action] = requiredPermission.split(':');\n          if (!permissionsStore.has(resource, action)) {\n            console.warn(`[Router Guard] Denied. Role does not have permission ${requiredPermission} for route ${to.name}.`);\n            ElMessage.warning('您的权限不足，無法访问此页面。');\n\n            // (如果連仪表板都没权限，强制登出)\n            if (to.name === 'Dashboard') {\n              localStorage.removeItem('admin_token');\n              permissionsStore.clearPermissions();\n              return next({\n                name: 'Login'\n              });\n            }\n            return next({\n              name: 'Dashboard'\n            });\n          }\n        }\n        next();\n      } catch (error) {\n        // (Token 过期 或 loadPermissions 失败)\n        console.error('Router Guard: Token/Permission check failed.', error.message);\n        localStorage.removeItem('admin_token');\n        permissionsStore.clearPermissions();\n        return next({\n          name: 'Login'\n        });\n      }\n    } else {\n      // (無 token)\n      permissionsStore.clearPermissions();\n      next({\n        name: 'Login'\n      });\n    }\n  } else {\n    // (访问 /login 页面)\n    if (token && to.name === 'Login') {\n      next({\n        name: 'Dashboard'\n      });\n    } else {\n      next();\n    }\n  }\n});\nexport default router;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}