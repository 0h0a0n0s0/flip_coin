{"ast":null,"code":"import { ElMessage, ElMessageBox } from 'element-plus';\nimport { jwtDecode } from 'jwt-decode';\nexport default {\n  name: 'AccountManagementView',\n  data() {\n    const validatePassword = (rule, value, callback) => {\n      if (!this.isEditMode && (!value || value.length < 6)) {\n        callback(new Error('新增帐号时，密码为必填且至少 6 位'));\n      } else if (this.isEditMode && value && value.length < 6) {\n        callback(new Error('密码至少 6 位'));\n      } else {\n        callback();\n      }\n    };\n    return {\n      loading: true,\n      submitLoading: false,\n      dialogLoading: false,\n      // (★★★ Y-22: 新增 ★★★)\n      tableData: [],\n      rolesList: [],\n      // (★★★ Y-23: 新增，用于下拉选单 ★★★)\n\n      dialogVisible: false,\n      dialogTitle: '',\n      isEditMode: false,\n      currentUserId: null,\n      // (★★★ Y-24: 修改 Form ★★★)\n      accountForm: {\n        id: null,\n        username: '',\n        password: '',\n        role_id: null,\n        // (从 'role' 改为 'role_id')\n        status: 'active'\n      },\n      formRules: {\n        username: [{\n          required: true,\n          message: '登入帐号不能为空',\n          trigger: 'blur'\n        }],\n        password: [{\n          validator: validatePassword,\n          trigger: 'blur'\n        }],\n        role_id: [{\n          required: true,\n          message: '必须选择一個角色',\n          trigger: 'change'\n        }],\n        // (★★★ Y-25: 修改规則 ★★★)\n        status: [{\n          required: true,\n          message: '狀态必须选择',\n          trigger: 'change'\n        }]\n      }\n    };\n  },\n  created() {\n    this.fetchAccounts();\n    this.fetchRolesList(); // (★★★ Y-26: 新增 ★★★)\n    this.getCurrentUserId();\n  },\n  methods: {\n    // (解码 Token)\n    getCurrentUserId() {\n      try {\n        const token = localStorage.getItem('admin_token');\n        const decoded = jwtDecode(token);\n        this.currentUserId = decoded.id;\n      } catch (e) {\n        console.error('Failed to decode token:', e);\n        this.$router.push('/login');\n      }\n    },\n    // (获取帐号列表)\n    async fetchAccounts() {\n      this.loading = true;\n      try {\n        // (API 現在会返回 role_name)\n        this.tableData = await this.$api.getAdminAccounts();\n      } catch (error) {\n        console.error('Failed to fetch admin accounts:', error);\n      } finally {\n        this.loading = false;\n      }\n    },\n    // (★★★ Y-27: 新增：获取角色列表 ★★★)\n    async fetchRolesList() {\n      try {\n        this.rolesList = await this.$api.getRoles();\n      } catch (error) {\n        console.error('Failed to fetch roles list:', error);\n        ElMessage.error('無法载入权限组列表');\n      }\n    },\n    // (清空表单)\n    resetForm() {\n      Object.assign(this.accountForm, {\n        id: null,\n        username: '',\n        password: '',\n        role_id: null,\n        status: 'active'\n      });\n    },\n    // (新增)\n    handleAdd() {\n      this.dialogTitle = '新增後台帐号';\n      this.isEditMode = false;\n      this.resetForm();\n      this.dialogVisible = true;\n      this.$nextTick(() => {\n        this.$refs.accountFormRef?.clearValidate();\n      });\n    },\n    // (编辑)\n    handleEdit(row) {\n      this.dialogTitle = `编辑帐号 ${row.username}`;\n      this.isEditMode = true;\n      // (★★★ Y-28: 修改：填充 role_id ★★★)\n      Object.assign(this.accountForm, {\n        id: row.id,\n        username: row.username,\n        password: '',\n        role_id: row.role_id,\n        // (使用 role_id)\n        status: row.status\n      });\n      this.dialogVisible = true;\n      this.$nextTick(() => {\n        this.$refs.accountFormRef?.clearValidate();\n      });\n    },\n    // (提交)\n    async handleSubmit() {\n      const formEl = this.$refs.accountFormRef;\n      if (!formEl) return;\n      await formEl.validate(async valid => {\n        if (valid) {\n          this.submitLoading = true;\n          try {\n            // (★★★ Y-29: 修改：提交 role_id ★★★)\n            const dataToSubmit = {\n              username: this.accountForm.username,\n              role_id: this.accountForm.role_id,\n              status: this.accountForm.status\n            };\n            // (只有在填寫时才提交密码)\n            if (this.accountForm.password) {\n              dataToSubmit.password = this.accountForm.password;\n            }\n            if (this.isEditMode) {\n              await this.$api.updateAdminAccount(this.accountForm.id, dataToSubmit);\n              ElMessage.success('帐号更新成功');\n            } else {\n              await this.$api.addAdminAccount(dataToSubmit);\n              ElMessage.success('帐号新增成功');\n            }\n            this.dialogVisible = false;\n            await this.fetchAccounts(); // 刷新列表\n          } catch (error) {\n            console.error('Failed to submit account:', error);\n          } finally {\n            this.submitLoading = false;\n          }\n        } else {\n          return false;\n        }\n      });\n    },\n    // (刪除)\n    handleDelete(row) {\n      if (row.id === 1 || row.id === this.currentUserId) {\n        ElMessage.warning('無法刪除此帐号');\n        return;\n      }\n      ElMessageBox.confirm(`确定要刪除帐号 \"${row.username}\" 吗？`, '警告', {\n        confirmButtonText: '确定刪除',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(async () => {\n        try {\n          await this.$api.deleteAdminAccount(row.id);\n          ElMessage.success('帐号刪除成功');\n          await this.fetchAccounts();\n        } catch (error) {\n          console.error('Failed to delete account:', error);\n        }\n      }).catch(() => {});\n    },\n    formatDateTime(isoString) {\n      if (!isoString) return '';\n      try {\n        return new Date(isoString).toLocaleString('zh-TW', {\n          timeZone: 'Asia/Taipei'\n        });\n      } catch (e) {\n        return isoString;\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}