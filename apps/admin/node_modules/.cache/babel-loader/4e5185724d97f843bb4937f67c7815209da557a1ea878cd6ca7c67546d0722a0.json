{"ast":null,"code":"import { ElMessage, ElMessageBox } from 'element-plus';\nexport default {\n  name: 'PermissionsView',\n  data() {\n    return {\n      loading: true,\n      submitLoading: false,\n      dialogLoading: false,\n      rolesList: [],\n      // { id, name, description, ... }\n      allPermissions: null,\n      // { General: [...], UserManagement: [...] }\n\n      dialogVisible: false,\n      dialogTitle: '',\n      isEditMode: false,\n      roleForm: {\n        // 弹窗表单\n        id: null,\n        name: '',\n        description: '',\n        permission_ids: [] // (选中的权限 ID 陣列)\n      },\n      formRules: {\n        // 表单验证规則\n        name: [{\n          required: true,\n          message: '角色名称不能为空',\n          trigger: 'blur'\n        }],\n        permission_ids: [{\n          type: 'array',\n          min: 1,\n          message: '至少必须选择一個权限',\n          trigger: 'change'\n        }]\n      }\n    };\n  },\n  created() {\n    this.fetchRoles();\n    this.fetchAllPermissions(); // (预先载入所有权限)\n  },\n  methods: {\n    // 翻译 Category (可选)\n    translateCategory(category) {\n      const map = {\n        'General': '通用权限',\n        'UserManagement': '用户管理',\n        'BetManagement': '注单管理',\n        'ReportManagement': '报表与钱包',\n        'System': '系统管理 (高风险)'\n      };\n      return map[category] || category;\n    },\n    // 获取角色列表\n    async fetchRoles() {\n      this.loading = true;\n      try {\n        this.rolesList = await this.$api.getRoles();\n      } catch (error) {\n        console.error('Failed to fetch roles:', error);\n      } finally {\n        this.loading = false;\n      }\n    },\n    // (僅执行一次) 获取所有可用的权限点\n    async fetchAllPermissions() {\n      try {\n        this.allPermissions = await this.$api.getAllPermissions();\n      } catch (error) {\n        console.error('Failed to fetch all permissions:', error);\n        ElMessage.error('無法载入权限列表，请刷新页面');\n      }\n    },\n    // (清空表单)\n    resetForm() {\n      Object.assign(this.roleForm, {\n        id: null,\n        name: '',\n        description: '',\n        permission_ids: []\n      });\n    },\n    // (新增)\n    handleAddRole() {\n      this.dialogTitle = '新增权限组';\n      this.isEditMode = false;\n      this.resetForm();\n      this.dialogVisible = true;\n      this.$nextTick(() => {\n        this.$refs.roleFormRef?.clearValidate();\n      });\n    },\n    // (编辑)\n    async handleEditRole(row) {\n      this.dialogTitle = `编辑权限组: ${row.name}`;\n      this.isEditMode = true;\n      this.resetForm();\n      this.dialogVisible = true;\n      this.dialogLoading = true;\n      try {\n        // 获取该角色的详細资料 (包含 permission_ids)\n        const roleDetails = await this.$api.getRoleDetails(row.id);\n        Object.assign(this.roleForm, {\n          id: roleDetails.id,\n          name: roleDetails.name,\n          description: roleDetails.description || '',\n          permission_ids: roleDetails.permission_ids || []\n        });\n        this.$nextTick(() => {\n          this.$refs.roleFormRef?.clearValidate();\n        });\n      } catch (error) {\n        console.error('Failed to fetch role details:', error);\n        this.dialogVisible = false;\n      } finally {\n        this.dialogLoading = false;\n      }\n    },\n    // (提交)\n    async handleSubmit() {\n      const formEl = this.$refs.roleFormRef;\n      if (!formEl) return;\n      await formEl.validate(async valid => {\n        if (valid) {\n          this.submitLoading = true;\n          try {\n            // (准备提交的 data)\n            const dataToSubmit = {\n              name: this.roleForm.name,\n              description: this.roleForm.description,\n              permission_ids: this.roleForm.permission_ids\n            };\n            if (this.isEditMode) {\n              await this.$api.updateRole(this.roleForm.id, dataToSubmit);\n              ElMessage.success('权限组更新成功');\n            } else {\n              await this.$api.addRole(dataToSubmit);\n              ElMessage.success('权限组新增成功');\n            }\n            this.dialogVisible = false;\n            await this.fetchRoles(); // 刷新列表\n          } catch (error) {\n            console.error('Failed to submit role:', error);\n          } finally {\n            this.submitLoading = false;\n          }\n        } else {\n          return false;\n        }\n      });\n    },\n    // (刪除)\n    handleDeleteRole(row) {\n      if ([1, 2, 3].includes(row.id)) {\n        ElMessage.warning('不能刪除系统预设角色');\n        return;\n      }\n      ElMessageBox.confirm(`确定要刪除权限组 \"${row.name}\" 吗？ (使用此权限组的帐号将失去所有权限)`, '警告', {\n        confirmButtonText: '确定刪除',\n        cancelButtonText: '取消',\n        type: 'warning'\n      }).then(async () => {\n        try {\n          await this.$api.deleteRole(row.id);\n          ElMessage.success('权限组刪除成功');\n          await this.fetchRoles(); // 刷新列表\n        } catch (error) {\n          console.error('Failed to delete role:', error);\n        }\n      }).catch(() => {});\n    },\n    formatDateTime(isoString) {\n      if (!isoString) return '';\n      try {\n        return new Date(isoString).toLocaleString('zh-TW', {\n          timeZone: 'Asia/Taipei'\n        });\n      } catch (e) {\n        return isoString;\n      }\n    }\n  }\n};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}