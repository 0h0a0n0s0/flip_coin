---
alwaysApply: true
---

# âš ï¸ FLIP COIN PROJECT CONSTITUTION

**Applied to every generation. Violations trigger an automatic stop.**

## 1. Tech Stack & Environment (Strict)

Cursor Must enforce:
* **Backend:** Node.js 18+, Express, PostgreSQL 14+, Socket.IO.
* **Frontend:** Vue 3 (Composition API only), Tailwind CSS, Pinia.
* **Blockchain:** TronWeb (TRON), ethers.js (EVM).
* **Package Manager:** pnpm (Workspace mode).

## 2. Architectural Rules (Global)

### 2.1 Monorepo Structure & Authority
* **`apps/web`** (`@flipcoin/web`): Public User UI. NO direct DB access. NO direct `services/` imports.
* **`apps/admin`** (`@flipcoin/admin`): Internal Staff UI. Requires VPN/IP Whitelist.
* **`services/wallet`** (`@flipcoin/service-wallet`): ðŸ›¡ï¸ **HIGH SECURITY**. Logic physically isolated. Accessed ONLY via HTTP/gRPC.
* **`packages/`**: Stateless code only (UI components, Schemas). NO business logic.

### 2.2 Dependency Boundaries
Cursor Must Not:
* Import `@flipcoin/database` directly into Frontend apps.
* Create circular dependencies between packages.

## 3. Financial & Blockchain Rules (CRITICAL - FROM README)

**Violation of this section is a Critical Security Failure.**

### 3.1 Wallet & Key Management
* **HD Wallet Paths:** Must use BIP44.
    * TRON: `m/44'/195'/0'/0/{index}`
    * EVM: `m/44'/60'/0'/0/{index}`
* **Index Allocation:**
    * **Dynamic Config:** Start Index MUST be loaded from Env/Config (e.g., `WALLET_START_INDEX`).
    * **Prohibition:** **NEVER hardcode** the start index (e.g., 1001) in code.
* **Key Storage:** NEVER store raw private keys in `users` table.

### 3.2 Transaction Logic
* **Deposit Listener:** Must use `blockchain_sync_status` to track block height.
* **TRON Collection:** Must use **Approve + TransferFrom** pattern.
    * Step 1: User Address `approve()` -> Collection Wallet.
    * Step 2: Collection Wallet `transferFrom()` -> Cold Wallet.
* **Concurrency:** Any balance update MUST use `SELECT ... FOR UPDATE NOWAIT` (Row Locking).

## 4. Backend Rules (API & Logic)

Cursor Must:
* **Structure:** `Route` (Validation) -> `Service` (Business Logic) -> `Response`.
* **No SQL in Routes:** All DB operations must stay in Services.
* **Standard Response:**
    * Success: `{ "success": true, "data": { ... } }`
    * Error: `{ "success": false, "error": "Human readable message" }`
* **Security:** Sanitize errors (No stack traces). Mask addresses/hashes in logs.

## 5. Frontend Rules (Vue 3)

Cursor Must:
* **Logic:** Use **Composition API** (`<script setup>`) exclusively.
* **API:** Use centralized `api.js`. NEVER use bare `fetch()`/`axios` in components.
* **State:** Centralize state in Pinia stores. Keep components < 300 lines.

## 6. UI Density & RWD (Casino-Grade)

Cursor Must maintain **Structural Parity** (H5 is a scaled version of Web, not a redesign).

### 6.1 Component Metrics (Strict)
* **Web GameCard:** Height ~180â€“210px.
* **H5 GameCard:** ~60â€“70% of Web size.
* **Quick Entry Card:** Web 88â€“110px; H5 68â€“82px.

### 6.2 Scaling Logic
* **Breakpoints:** Desktop >= 1280, Mobile <= 767.
* **H5 Scaling:** Spacing 70â€“80%, Icons 80â€“90%, Cards 60â€“70% of Desktop.
* **Styling:** Use Design Tokens (space-1 to space-6, radius 4/8/12px). NO raw hex colors.

## 7. Development Workflow

* **Naming:** `camelCase` for vars, `PascalCase` for Components.
* **Versioning:** Update CHANGELOG.md. NO version comments (`// v1.2`) in code.

## 8. Automatic Simulation Checklist (Mandatory)

**Before generating code, Cursor must perform these internal checks:**

### 8.1 Safety & Business Check
1.  **Hardcoding:** Am I writing a magic number (like 1001)? â†’ Change to Config.
2.  **Concurrency:** Am I modifying balance? â†’ **Add DB Lock**.
3.  **Chain Logic:** Am I using TRON direct transfer? â†’ **Change to Approve+TransferFrom**.
4.  **Layers:** Am I writing SQL in a Route? â†’ Move to Service.

### 8.2 Frontend Simulation
1.  **Visuals:** Did I use tokens? Is the text visible (contrast)?
2.  **RWD:** Did I break the layout on mobile? (Must be proportional scale).

### 8.3 API Contract Check
1.  **Format:** Does output match `{ "success": true, "data": ... }`?
2.  **Handshake:** Does the Frontend payload match Backend Validator expectations?

## 9. Language Protocol (Strict)

Cursor Must enforce:
* **Interaction:** All reasoning, explanations, and chat responses MUST be in **Simplified Chinese (ç®€ä½“ä¸­æ–‡)**.
* **Code Comments:** All code comments, JSDoc, and documentation within files MUST be in **Simplified Chinese**.
* **Strings & Logs:**
    * Server-side logs and error messages: **Simplified Chinese**.
    * Frontend UI: Prioritize `zh-CN` i18n entries. If hardcoding strings is necessary/requested, use **Simplified Chinese**.

**If any violation is detected: STOP and ask the user.**