# docker-compose.yml
version: '3.8' # 指定 docker-compose 文件版本

services:
  # 後端 API 服務
  api:
    build: ./backend # 指示 Docker Compose 使用 backend 資料夾中的 Dockerfile 來建構映像
    container_name: flipcoin-api
    ports:
      - "3000:3000" # 將本機的 3000 port 映射到容器的 3000 port
    volumes:
      - ./backend:/usr/src/app # 將本地的 backend 資料夾同步到容器中，方便開發時即時更新程式碼
      - /usr/src/app/node_modules # 避免本地的 node_modules 覆蓋容器中的
    depends_on:
      - db # 確保 db 服務先於 api 服務啟動
    env_file:
      - .env  # 環境變數檔案
    environment:
      - DATABASE_URL=postgres://game_user:game_password@db:5432/flipcoin_db
    restart: unless-stopped

  # 資料庫服務
  db:
    image: postgres:14-alpine # 使用官方的 PostgreSQL 映像
    container_name: flipcoin-db
    environment:
      POSTGRES_USER: game_user # 設定資料庫使用者
      POSTGRES_PASSWORD: game_password # 設定資料庫密碼
      POSTGRES_DB: flipcoin_db # 設定資料庫名稱
    ports:
      - "5432:5432" # 將本機的 5432 port 映射到容器的 5432 port
    volumes:
      - postgres_data:/var/lib/postgresql/data # 持久化資料庫資料
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql # 專案啟動時執行的初始化 SQL 檔案
    restart: unless-stopped

volumes:
  postgres_data: # 定義一個 volume 來儲存資料庫資料，防止容器關閉後資料遺失