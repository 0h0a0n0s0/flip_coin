# docker-compose.yml

services:
  # 後端 API 服務
  api:
    build:
      context: .
      dockerfile: ./apps/backend-legacy/Dockerfile
    container_name: flipcoin-api
    ports:
      - "3000:3000" 
    volumes:
      - ./apps/backend-legacy:/usr/src/app/apps/backend-legacy
      - ./packages:/usr/src/app/packages
      - /usr/src/app/node_modules
      - /usr/src/app/apps/backend-legacy/node_modules
      - ./index.html:/usr/src/app/apps/backend-legacy/v1_frontend/index.html
      - ./app.js:/usr/src/app/apps/backend-legacy/v1_frontend/app.js
      - ./style.css:/usr/src/app/apps/backend-legacy/v1_frontend/style.css
      - ./modules:/usr/src/app/apps/backend-legacy/v1_frontend/modules
      - ./403.html:/usr/src/app/apps/backend-legacy/v1_frontend/403.html
      - ./apps/web/src/locales:/usr/src/app/apps/backend-legacy/frontend-vue3/src/locales
    dns:
      - 8.8.8.8
      - 1.1.1.1  
    extra_hosts:
      - "nile.getblock.io:52.20.141.144"
    depends_on:
      db:
        condition: service_healthy 
    env_file:
      - .env    
    environment:
      - DATABASE_URL=postgres://game_user:game_password@db:5432/flipcoin_db
    healthcheck:
      # 檢查 API 服務是否就緒（使用 node 內建模組測試）
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  # 資料庫服務
  db:
    image: postgres:14-alpine 
    container_name: flipcoin-db
    environment:
      POSTGRES_USER: game_user 
      POSTGRES_PASSWORD: game_password 
      POSTGRES_DB: flipcoin_db 
    ports:
      - "5432:5432" 
    volumes:
      - postgres_data:/var/lib/postgresql/data 
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql 
    healthcheck:
      # 測試命令：檢查服務是否啟動並確認表已建立
      test: ["CMD-SHELL", "pg_isready -U game_user -d flipcoin_db && psql -U game_user -d flipcoin_db -c 'SELECT 1 FROM admin_ip_whitelist'"]
      interval: 5s
      timeout: 5s
      retries: 10
      
    restart: unless-stopped

  # 後台前端 UI 服務
  admin-ui:
    build:
      context: .
      dockerfile: ./apps/admin/Dockerfile
    container_name: flipcoin-admin-ui
    # 不直接暴露端口，由 Nginx 代理
    restart: unless-stopped

  # Vue 3 前端服務
  frontend-vue3:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile
    container_name: flipcoin-frontend-vue3
    # 不直接暴露端口，由 nginx 代理
    restart: unless-stopped

  # Nginx 代理服務
  nginx:
    build: ./nginx # 指向我們剛才建立的 nginx 資料夾
    container_name: flipcoin-proxy
    ports:
      - "${NGINX_PORT:-8080}:80" # 使用環境變數，預設 8080
    depends_on:
      api:
        condition: service_healthy  # 等待 api 健康檢查通過
      admin-ui:
        condition: service_started  # 前端服務只需啟動即可
      frontend-vue3:
        condition: service_started  # 前端服務只需啟動即可
    env_file:
      - .env       # 讀取環境變數
    environment:
      - NGINX_SERVER_NAME=${NGINX_SERVER_NAME:-localhost} # 域名，預設 localhost
    restart: unless-stopped

volumes:
  postgres_data: