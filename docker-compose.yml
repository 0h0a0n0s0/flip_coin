# docker-compose.yml (修改)
version: '3.8' 

services:
  # 後端 API 服務 (v1)
  api:
    build: ./backend 
    container_name: flipcoin-api
    ports:
      - "3000:3000" 
    volumes:
      - ./backend:/usr/src/app
      - /usr/src/app/node_modules
      - ./index.html:/usr/src/app/v1_frontend/index.html
      - ./app.js:/usr/src/app/v1_frontend/app.js
      - ./style.css:/usr/src/app/v1_frontend/style.css
      - ./modules:/usr/src/app/v1_frontend/modules
      - ./403.html:/usr/src/app/v1_frontend/403.html
    depends_on:
      db:
        condition: service_healthy 
    env_file:
      - .env  
    environment:
      - DATABASE_URL=postgres://game_user:game_password@db:5432/flipcoin_db
    restart: unless-stopped

  # 資料庫服務 (v1)
  db:
    image: postgres:14-alpine 
    container_name: flipcoin-db
    environment:
      POSTGRES_USER: game_user 
      POSTGRES_PASSWORD: game_password 
      POSTGRES_DB: flipcoin_db 
    ports:
      - "5432:5432" 
    volumes:
      - postgres_data:/var/lib/postgresql/data 
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql 
    healthcheck:
      # 測試命令：
      # 1. pg_isready 檢查服務是否啟動
      # 2. (&&) psql 嘗試查詢 init.sql 中的 *最後一張表* (admin_ip_whitelist)
      # 只有當這張表存在時 (init.sql 執行完畢)，檢查才會通過
      test: ["CMD-SHELL", "pg_isready -U game_user -d flipcoin_db && psql -U game_user -d flipcoin_db -c 'SELECT 1 FROM admin_ip_whitelist'"]
      interval: 5s
      timeout: 5s
      retries: 10
      
    restart: unless-stopped

  # (v2 修改) 後台前端 UI 服務
  admin-ui:
    build: ./admin-ui 
    container_name: flipcoin-admin-ui
    # (★★★ 刪除 ports ★★★)
    # 移除 ports: - "8080:80"
    # 因為 Nginx 將會代理它，它不需要對外開放
    restart: unless-stopped

  # (v2 新增) Nginx 代理服務
  nginx:
    build: ./nginx # 指向我們剛才建立的 nginx 資料夾
    container_name: flipcoin-proxy
    ports:
      - "8080:80" # (★★★ 關鍵 ★★★) 瀏覽器訪問 8080
    depends_on:
      - api        # 確保 Nginx 在 api 之後啟動
      - admin-ui   # 確保 Nginx 在 admin-ui 之後啟動
    restart: unless-stopped

volumes:
  postgres_data: