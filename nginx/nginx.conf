# 檔案: nginx/nginx.conf (自訂主配置，包含 realip 模組設定)

user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # (★★★ 使用 realip 模組：將 Docker 網關 IP 視為可信代理 ★★★)
    # 這樣 Nginx 會從 X-Forwarded-For 中提取真實 IP，而不是使用 $remote_addr
    set_real_ip_from 172.16.0.0/12;   # Docker 網橋網路範圍 (172.16.0.0 - 172.31.255.255)
    set_real_ip_from 192.168.65.0/24; # Docker Desktop 網關範圍 (macOS)
    set_real_ip_from 192.168.0.0/16;  # 一般私有網路範圍
    set_real_ip_from 10.0.0.0/8;      # 私有網路範圍
    real_ip_header X-Forwarded-For;    # 從 X-Forwarded-For 頭中提取真實 IP
    real_ip_recursive on;              # 遞歸查找，跳過所有可信代理

    # 包含 server 配置
    include /etc/nginx/conf.d/*.conf;
}

