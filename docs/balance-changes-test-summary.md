# è´¦å˜è®°å½•ç³»ç»Ÿæµ‹è¯•æ‘˜è¦

## âœ… æ­¥éª¤ 1ï¼šæ•°æ®åº“è¿ç§» - å·²å®Œæˆ

### æ‰§è¡Œç»“æœ
- âœ… `balance_changes` è¡¨å·²æˆåŠŸåˆ›å»º
- âœ… æ‰€æœ‰ç´¢å¼•å·²åˆ›å»ºï¼š
  - `idx_balance_changes_user_id`
  - `idx_balance_changes_change_type`
  - `idx_balance_changes_created_at`
  - `idx_balance_changes_user_created`
- âœ… å¤–é”®çº¦æŸå·²è®¾ç½®
- âœ… è¡¨æ³¨é‡Šå·²æ·»åŠ 

### æƒé™è®¾ç½®
- âœ… æƒé™ `balance_changes:read` å·²æ·»åŠ åˆ° `admin_permissions` è¡¨
- âœ… æƒé™å·²åˆ†é…ç»™æ‰€æœ‰è§’è‰²ï¼š
  - Super Admin âœ…
  - Admin âœ…
  - Operator âœ…

### éªŒè¯å‘½ä»¤
```bash
# æŸ¥çœ‹è¡¨ç»“æ„
docker exec -i flipcoin-db psql -U game_user -d flipcoin_db -c "\d balance_changes"

# æŸ¥çœ‹æƒé™åˆ†é…
docker exec -i flipcoin-db psql -U game_user -d flipcoin_db -c "SELECT r.name, p.resource, p.action FROM admin_role_permissions rp JOIN admin_roles r ON rp.role_id = r.id JOIN admin_permissions p ON rp.permission_id = p.id WHERE p.resource = 'balance_changes';"
```

## âœ… æ­¥éª¤ 2ï¼šå‰ç«¯é¡µé¢å’Œ API æµ‹è¯•

### åç«¯ API
- âœ… è·¯ç”± `/api/admin/balance-changes` å·²æ·»åŠ åˆ° `backend/routes/admin.js`
- âœ… åç«¯è·¯ç”±æ¨¡å—åŠ è½½æˆåŠŸï¼ˆæ— è¯­æ³•é”™è¯¯ï¼‰
- âœ… API ç«¯ç‚¹è¿”å› 403ï¼ˆæ­£å¸¸ï¼Œéœ€è¦è®¤è¯ï¼‰

### å‰ç«¯é¡µé¢
- âœ… é¡µé¢æ–‡ä»¶ `admin-ui/src/views/finance/BalanceChanges.vue` å·²åˆ›å»º
- âœ… è·¯ç”± `/finance/balance-changes` å·²æ·»åŠ åˆ°è·¯ç”±é…ç½®
- âœ… èœå•é¡¹ã€Œè´¦å˜è®°å½•ã€å·²æ·»åŠ åˆ°è´¢åŠ¡ç®¡ç†èœå•
- âœ… API è°ƒç”¨å‡½æ•° `getBalanceChanges()` å·²æ·»åŠ åˆ° API æ¨¡å—

### å‰ç«¯åŠŸèƒ½ç‰¹æ€§
- âœ… è´¦å˜é‡‘é¢æ˜¾ç¤ºï¼šæ­£æ•°ç»¿è‰²ï¼Œè´Ÿæ•°çº¢è‰²
- âœ… æ”¯æŒç­›é€‰æŸ¥è¯¢ï¼š
  - ç”¨æˆ·åï¼ˆæ¨¡ç³Šï¼‰
  - ç”¨æˆ·IDï¼ˆç²¾ç¡®ï¼‰
  - è´¦å˜ç±»å‹ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
  - æ—¶é—´èŒƒå›´ï¼ˆæ—¥æœŸæ—¶é—´é€‰æ‹©å™¨ï¼‰
- âœ… æ”¯æŒåˆ†é¡µ
- âœ… æ˜¾ç¤ºæ‰€æœ‰å¿…è¦å­—æ®µï¼š
  - è´¦å˜ID
  - ç”¨æˆ·ID
  - ç”¨æˆ·å
  - è´¦å˜ç±»å‹ï¼ˆå¸¦æ ‡ç­¾é¢œè‰²ï¼‰
  - è´¦å˜é‡‘é¢ï¼ˆæ­£ç»¿è´Ÿçº¢ï¼‰
  - è´¦å˜åä½™é¢
  - å¤‡æ³¨
  - æ—¶é—´

## ğŸ“‹ æµ‹è¯•æ¸…å•

### æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

1. **è®¿é—®å‰ç«¯é¡µé¢**
   - æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:8080`
   - ç™»å½•åå°ç®¡ç†ç³»ç»Ÿ
   - å¯¼èˆªåˆ°ã€Œè´¢åŠ¡ç®¡ç†ã€â†’ã€Œè´¦å˜è®°å½•ã€
   - âœ… é¡µé¢åº”è¯¥æ­£å¸¸åŠ è½½

2. **æµ‹è¯•APIç«¯ç‚¹**ï¼ˆéœ€è¦ç®¡ç†å‘˜ç™»å½•ï¼‰
   ```bash
   # è·å–è®¤è¯Tokenåæµ‹è¯•
   curl -H "Authorization: Bearer YOUR_TOKEN" \
        "http://localhost:3000/api/admin/balance-changes?page=1&limit=10"
   ```

3. **æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½**
   - æµ‹è¯•æŒ‰ç”¨æˆ·åæœç´¢
   - æµ‹è¯•æŒ‰ç”¨æˆ·IDæœç´¢
   - æµ‹è¯•æŒ‰è´¦å˜ç±»å‹ç­›é€‰
   - æµ‹è¯•æŒ‰æ—¶é—´èŒƒå›´ç­›é€‰

4. **æµ‹è¯•åˆ†é¡µåŠŸèƒ½**
   - åˆ‡æ¢é¡µé¢
   - ä¿®æ”¹æ¯é¡µæ˜¾ç¤ºæ•°é‡

### é¢„æœŸç»“æœ
- é¡µé¢æ­£å¸¸æ˜¾ç¤ºï¼ˆå³ä½¿æ²¡æœ‰æ•°æ®ä¹Ÿåº”æ˜¾ç¤ºç©ºåˆ—è¡¨ï¼‰
- æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- åˆ†é¡µåŠŸèƒ½æ­£å¸¸
- API è¿”å›æ­£ç¡®çš„ JSON æ ¼å¼ï¼š
  ```json
  {
    "total": 0,
    "list": []
  }
  ```

## ğŸ”§ ä¸‹ä¸€æ­¥å·¥ä½œ

### éœ€è¦æ·»åŠ è´¦å˜è®°å½•çš„ä½ç½®

æ ¹æ® `docs/balance-changes-integration.md` æ–‡æ¡£ï¼Œéœ€è¦åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ è´¦å˜è®°å½•ï¼š

1. **å……å€¼** (`backend/services/TronListener.js`)
   - ç±»å‹ï¼š`deposit`
   - é‡‘é¢ï¼šæ­£æ•°

2. **ææ¬¾** (`backend/routes/admin.js`)
   - ç±»å‹ï¼š`withdrawal`
   - é‡‘é¢ï¼šæ­£æ•°ï¼ˆé€€æ¬¾ï¼‰æˆ–è´Ÿæ•°ï¼ˆææ¬¾ï¼‰

3. **ä¸‹æ³¨** (`backend/services/BetQueueService.js`)
   - ç±»å‹ï¼š`bet`
   - é‡‘é¢ï¼šè´Ÿæ•°

4. **æ´¾å¥–** (`backend/services/BetQueueService.js` æˆ– `PayoutService.js`)
   - ç±»å‹ï¼š`payout`
   - é‡‘é¢ï¼šæ­£æ•°

5. **äººå·¥è°ƒæ•´** (`backend/routes/admin.js`)
   - ç±»å‹ï¼š`manual_adjust`
   - é‡‘é¢ï¼šæ­£æ•°æˆ–è´Ÿæ•°

6. **æ´»åŠ¨å¥–é‡‘**ï¼ˆå¦‚æœæœ‰ï¼‰
   - ç±»å‹ï¼š`activity_bonus`
   - é‡‘é¢ï¼šæ­£æ•°

### é›†æˆç¤ºä¾‹

å‚è€ƒ `docs/balance-changes-integration.md` ä¸­çš„ç¤ºä¾‹ä»£ç è¿›è¡Œé›†æˆã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»å·²å®Œæˆ**ï¼Œä¸éœ€è¦å†æ¬¡è¿è¡Œ
2. **æƒé™å·²é…ç½®**ï¼Œæ‰€æœ‰è§’è‰²éƒ½å¯ä»¥è®¿é—®è´¦å˜è®°å½•
3. **å‰ç«¯é¡µé¢å·²åˆ›å»º**ï¼Œéœ€è¦é‡æ–°æ„å»ºå‰ç«¯ï¼ˆå¦‚æœä½¿ç”¨æ„å»ºç‰ˆæœ¬ï¼‰
4. **åç«¯APIå·²å°±ç»ª**ï¼Œç­‰å¾…é›†æˆè´¦å˜è®°å½•å†™å…¥åŠŸèƒ½

## âœ… ç³»ç»ŸçŠ¶æ€

- âœ… æ•°æ®åº“è¡¨å·²åˆ›å»º
- âœ… æƒé™å·²é…ç½®
- âœ… åç«¯APIå·²å®ç°
- âœ… å‰ç«¯é¡µé¢å·²åˆ›å»º
- âœ… è·¯ç”±å·²é…ç½®
- âœ… èœå•å·²æ·»åŠ 
- â³ ç­‰å¾…æ·»åŠ è´¦å˜è®°å½•å†™å…¥åŠŸèƒ½ï¼ˆé›†æˆå·¥ä½œï¼‰

