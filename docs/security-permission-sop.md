# 權限與資安 SOP

此文件提供開發與營運團隊在新增功能、調整權限、部署與日常維運時需遵守的安全標準流程。所有開發與操作均應遵循以下規範。

---

## 1. 權限管理

### 1.1 角色 / 權限變更流程
1. **需求提出**：任何新增/調整角色或權限點的需求，需由系統負責人（或資訊安全負責人）提出 Jira / 任務單，包含需求背景與影響範圍。
2. **風險評估**：開發或資安人員評估是否會增加敏感資料暴露風險，是否需同步調整 Audit Log。
3. **實作**：調整 `admin_permissions`、`admin_role_permissions` 以及前端 `router/meta.permission` 對應表。
4. **測試**：針對所有受影響角色進行手動驗證（登入、瀏覽頁面、操作），確保權限正確。
5. **稽核**：每次角色/權限調整均需記錄於 `admin_audit_logs`，並在週報中提交變更摘要。

### 1.2 最小授權原則
- 後台帳號僅授權其必要資源（避免使用通用的 super admin）。
- API 層在執行資料查詢與變更時，必須檢查 `checkPermission(resource, action)`。新建 API 時，需於開發階段同時規劃權限點。
- 若遇到例外需求（臨時授權），需設定授權有效期限並於到期時自動回收。

### 1.3 帳號安全
- 後台帳號需啟用多因素驗證 (MFA)；如無硬體/軟體支援，至少要求 VPN + IP 白名單。
- 登录錯誤超過 5 次需鎖定帳號或強制等待時間，並記錄 audit log。
- 定期（至少每月）檢查並回收無人使用或已離職人員帳號。

---

## 2. 敏感資料保護

### 2.1 資料分類
| 資料類型 | 範例 | 保護方式 | 備註 |
| --- | --- | --- | --- |
| 極度敏感 | 平台私鑰、提款地址、TRON/EVM 地址、提款密碼 hash | 僅後端存取、必要時加密/遮蔽 | 需納入 KMS/加密 |
| 敏感 | 使用者基本資料、API Token | 僅後端/特定管理員可完整查看 | 前端預設遮蔽 |
| 一般 | 公開資訊、排行榜 | 可一般顯示 | 仍需防範 tampering |

### 2.2 加密與遮蔽
- **儲存時加密**：私鑰或交易敏感資料需使用 KMS 或 AES-GCM 加密後儲存。若暫時無法導入，至少使用加密檔案保存在後端伺服器並限制檔案權限。
- **傳輸時最小化**：API 回應僅提供必要欄位，敏感欄位改為 `*_masked` 形式，除非前端在「顯示完整」時再向後端申請授權。
- **日誌遮蔽**：任何寫入 log（console、audit log）的資訊，若包含地址、Tx Hash 等，僅記錄前後 4~6 碼。

### 2.3 匯出 / 傳送資料
- 匯出報表或資料備份必須經過負責人核准，並於 `admin_audit_logs` 留下紀錄。
- 檔案應加密（如 zip + 密碼），並透過安全通道傳送（SFTP、專用雲端）。

---

## 3. 申請與開發流程

### 3.1 新增 API / 功能開發
1. 撰寫需求時，需註明是否涉及敏感資料、新增權限點。
2. 開發階段：
   - 先定義後端 `resource:action` 權限，再撰寫 API。
   - 加入輸入驗證、Rate Limit、`sendError` 統一錯誤訊息。
   - 若 API 會返回敏感資料，必須提供遮蔽後的欄位。
3. Code Review：
   - 確認已使用 `checkPermission`、輸入驗證、mask/pagination 等。
   - 檢視是否有 console.log 洩漏資料。
4. 測試：
   - 使用含不同權限的測試帳號驗證行為。
   - 若為敏感 API，需於測試報告中附上結果。

### 3.2 部署 / 發佈
- 部署前執行自動化測試與 lint。
- 檢查環境變數是否一致（尤其是新的金鑰或密碼）。
- 部署完成後驗證 audit log 是否正常寫入。

---

## 4. 稽核與監控

### 4.1 Audit Log 規則
- 每個敏感操作（系統設定、錢包、IP 白名單、提款審核等）必須寫入 `admin_audit_logs`。
- Log 內容需包含：操作人員 ID/帳號、動作、資源、描述、IP、User-Agent、時間。
- 每週由系統負責人匯出稽核報表，檢查異常操作（例如凌晨大量修改設定）。

### 4.2 安全檢查
- 每月進行一次「權限審計」，確認無多餘權限。
- 每季進行一次「資安巡檢」，內容包含：
  - 檢查所有 API 是否有適當權限控制。
  - 測試常見攻擊（SQL Injection、XSS、CSRF）。
  - 檢查資安套件與依賴是否更新。

---

## 5. 附錄

### 5.1 常用工具
- `maskUtils.js`：提供遮蔽函式於 API/前端使用。
- `auditLogService.js`：統一記錄敏感操作。
- `safeResponse.js`：統一錯誤訊息輸出。

### 5.2 聯絡窗口
- 系統負責人：`<請填入姓名/Email>`
- 資安負責人：`<請填入姓名/Email>`

---

> **提醒**：本 SOP 需與團隊開發流程緊密結合，當有新功能或新的敏感資料時，務必更新此文件並知會所有相關人員。任何例外情況皆需經資訊安全負責人書面核准。

