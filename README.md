# Flip Coin é¡¹ç›®

ä¸€ä¸ªåŸºäºåŒºå—é“¾çš„æŠ•æ³¨æ¸¸æˆå¹³å°ï¼Œæ”¯æŒå¤šé“¾ï¼ˆTRC20ã€BSCã€ETHã€Polygonã€Solanaï¼‰USDT å……å€¼å’Œææ¬¾ã€‚

## ğŸ“‹ é¡¹ç›®ç»“æ„

```
flip_coin/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/                   # Vue 3 å‰ç«¯ï¼ˆæ–°ï¼‰(@flipcoin/web)
â”‚   â”œâ”€â”€ admin/                 # åå°ç®¡ç†å‰ç«¯ (@flipcoin/admin)
â”‚   â””â”€â”€ backend-legacy/        # åç«¯æœåŠ¡ (Node.js + Express) (@flipcoin/backend-legacy)
â”‚       â”œâ”€â”€ routes/            # API è·¯ç”±
â”‚       â”‚   â””â”€â”€ admin.js       # åå°ç®¡ç† API
â”‚       â”œâ”€â”€ middleware/        # ä¸­é—´ä»¶
â”‚       â”‚   â”œâ”€â”€ auth.js        # èº«ä»½éªŒè¯
â”‚       â”‚   â”œâ”€â”€ adminIpWhitelistMiddleware.js
â”‚       â”‚   â”œâ”€â”€ checkPermissionMiddleware.js
â”‚       â”‚   â”œâ”€â”€ ipBlockerMiddleware.js
â”‚       â”‚   â””â”€â”€ rateLimiter.js
â”‚       â”œâ”€â”€ services/          # ä¸šåŠ¡é€»è¾‘æœåŠ¡å±‚
â”‚       â”‚   â”œâ”€â”€ KmsService.js  # å¯†é’¥ç®¡ç†æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ TronListener.js # TRON é“¾ç›‘å¬
â”‚       â”‚   â”œâ”€â”€ TronCollectionService.js  # å½’é›†æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ GameOpenerService.js      # å¼€å¥–æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ BetQueueService.js        # æŠ•æ³¨é˜Ÿåˆ—
â”‚       â”‚   â”œâ”€â”€ PayoutService.js          # è‡ªåŠ¨å‡ºæ¬¾æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ PendingBetProcessor.js   # å¾…å¤„ç†æŠ•æ³¨
â”‚       â”‚   â”œâ”€â”€ WalletBalanceMonitor.js  # é’±åŒ…ä½™é¢ç›‘æ§
â”‚       â”‚   â”œâ”€â”€ riskControlService.js     # é£æ§æœåŠ¡
â”‚       â”‚   â”œâ”€â”€ auditLogService.js        # å®¡è®¡æ—¥å¿—
â”‚       â”‚   â””â”€â”€ settingsCache.js          # è®¾ç½®ç¼“å­˜
â”‚       â”œâ”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚       â”‚   â”œâ”€â”€ balanceChangeLogger.js
â”‚       â”‚   â”œâ”€â”€ gameUtils.js
â”‚       â”‚   â”œâ”€â”€ ipUtils.js
â”‚       â”‚   â”œâ”€â”€ maskUtils.js
â”‚       â”‚   â””â”€â”€ safeResponse.js
â”‚       â”œâ”€â”€ validators/        # è¾“å…¥éªŒè¯
â”‚       â”‚   â””â”€â”€ authValidators.js
â”‚       â”œâ”€â”€ scripts/           # ç»´æŠ¤è„šæœ¬
â”‚       â”œâ”€â”€ v1_frontend/       # æ—§ç‰ˆå‰ç«¯ï¼ˆå·²å¼ƒç”¨ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
â”‚       â””â”€â”€ server.js          # æœåŠ¡å™¨å…¥å£
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ database/              # æ•°æ®åº“è¿æ¥å’Œè¿ç§» (@flipcoin/database)
â”‚   â”‚   â”œâ”€â”€ index.js           # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â””â”€â”€ migrations/        # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â””â”€â”€ ui/                    # å…±äº« UI ç»„ä»¶ (@flipcoin/ui)
â”‚
â”œâ”€â”€ services/
â”‚   â””â”€â”€ wallet/                # é’±åŒ…æœåŠ¡ (@flipcoin/service-wallet)
â”‚
â”œâ”€â”€ apps/web/                  # Vue 3 å‰ç«¯ï¼ˆæ–°ï¼‰
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ api/               # API è¯·æ±‚æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ components/         # Vue ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ layout/        # å¸ƒå±€ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ game/          # æ¸¸æˆç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ wallet/        # é’±åŒ…ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/          # è®¤è¯ç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ common/        # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”‚   â””â”€â”€ ui/            # UI ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ composables/       # Composition API hooks
â”‚   â”‚   â”œâ”€â”€ views/             # é¡µé¢è§†å›¾
â”‚   â”‚   â”œâ”€â”€ router/            # è·¯ç”±é…ç½®
â”‚   â”‚   â”œâ”€â”€ store/             # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ locales/           # å¤šè¯­ç³»æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ styles/            # æ ·å¼æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ nginx.conf
â”‚
â”œâ”€â”€ apps/admin/                # åå°ç®¡ç†å‰ç«¯ (Vue.js + Element Plus) (@flipcoin/admin)
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ views/             # ç®¡ç†é¡µé¢
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/         # ç®¡ç†å‘˜ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ finance/       # è´¢åŠ¡ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ games/         # æ¸¸æˆç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ risk/          # é£æ§ç®¡ç†
â”‚   â”‚   â”‚   â””â”€â”€ settings/      # ç³»ç»Ÿè®¾ç½®
â”‚   â”‚   â”œâ”€â”€ components/         # ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ api/               # API æ¨¡å—
â”‚   â”‚   â””â”€â”€ router/            # è·¯ç”±
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ nginx/                     # Nginx é…ç½®
â”‚   â”œâ”€â”€ default.conf
â”‚   â”œâ”€â”€ nginx.conf
â”‚   â””â”€â”€ Dockerfile
â”‚
â”œâ”€â”€ modules/                    # æ—§ç‰ˆå‰ç«¯æ¨¡å—ï¼ˆå·²å¼ƒç”¨ï¼Œä¿ç•™ç”¨äºå…¼å®¹ï¼‰
â”‚   â”œâ”€â”€ api.js
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ game.js
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ migrations/                 # æ ¹ç›®å½•è¿ç§»æ–‡ä»¶
â”‚
â”œâ”€â”€ docker-compose.yml         # Docker Compose é…ç½®
â”œâ”€â”€ init.sql                   # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ PROJECT_CONSTITUTION.md    # é¡¹ç›®å¼€å‘å®ªæ³•
â””â”€â”€ CHANGELOG.md              # å˜æ›´æ—¥å¿—
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®è¦æ±‚

- Docker & Docker Compose
- Node.js 18+ (å¼€å‘æ¨¡å¼)
- PostgreSQL 14+ (æˆ–ä½¿ç”¨ Docker)

### å¯åŠ¨é¡¹ç›®

```bash
# 1. å…‹éš†é¡¹ç›®
git clone <repository-url>
cd flip_coin

# 2. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥å¿…è¦çš„é…ç½®

# 3. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# 4. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

### è®¿é—®åœ°å€

- **å‰ç«¯**: http://localhost:8080
- **åå°ç®¡ç†**: http://localhost:8080/admin
- **API**: http://localhost:8080/api/v1
- **æ•°æ®åº“**: localhost:5432

## ğŸ—ï¸ æŠ€æœ¯æ ˆ

### åç«¯
- **Node.js** + **Express** - Web æ¡†æ¶
- **PostgreSQL** - æ•°æ®åº“
- **Socket.IO** - å®æ—¶é€šä¿¡
- **Passport.js** - èº«ä»½éªŒè¯
- **ethers.js** - åŒºå—é“¾äº¤äº’

### å‰ç«¯ (Vue 3)
- **Vue 3** - å‰ç«¯æ¡†æ¶
- **Vue Router** - è·¯ç”±
- **Pinia** - çŠ¶æ€ç®¡ç†
- **Tailwind CSS** - æ ·å¼æ¡†æ¶
- **Socket.IO Client** - å®æ—¶é€šä¿¡
- **vue-i18n** - å¤šè¯­ç³»æ”¯æŒ

### åå°ç®¡ç†
- **Vue.js** + **Element Plus** - UI æ¡†æ¶

## ğŸ“ æ ¸å¿ƒåŠŸèƒ½

### æ¸¸æˆåŠŸèƒ½
- âœ… Flip Coin æŠ•æ³¨æ¸¸æˆ
- âœ… å®æ—¶å¼€å¥–
- âœ… è¿èƒœè®°å½•
- âœ… æ’è¡Œæ¦œ

### é’±åŒ…åŠŸèƒ½
- âœ… å¤šé“¾æ”¯æŒï¼ˆTRC20ã€BSCã€ETHã€Polygonã€Solanaï¼‰
- âœ… è‡ªåŠ¨å½’é›†
- âœ… è‡ªåŠ¨å‡ºæ¬¾
- âœ… å……å€¼/ææ¬¾å†å²

### åå°ç®¡ç†
- âœ… ç”¨æˆ·ç®¡ç†
- âœ… æŠ•æ³¨ç®¡ç†
- âœ… è´¢åŠ¡ç®¡ç†
- âœ… æ¸¸æˆç®¡ç†
- âœ… é£æ§ç®¡ç†
- âœ… ç³»ç»Ÿè®¾ç½®
- âœ… å¤šè¯­ç³»ç®¡ç†

## ğŸ’° ç”¨æˆ·é‡‘æµæµç¨‹

### 1. é’±åŒ…åœ°å€åˆ†é…æœºåˆ¶

#### 1.1 åˆ†é…æ–¹å¼
- **æŠ€æœ¯å®ç°**: ä½¿ç”¨ HD (Hierarchical Deterministic) é’±åŒ…æ´¾ç”Ÿ
- **ä¸»å¯†é’¥**: ä» `MASTER_MNEMONIC` (ç¯å¢ƒå˜é‡) æ´¾ç”Ÿæ‰€æœ‰å­é’±åŒ…
- **æ´¾ç”Ÿè·¯å¾„**:
  - EVM é“¾ (BSC/ETH/Polygon): `m/44'/60'/0'/0/{index}`
  - TRON é“¾: `m/44'/195'/0'/0/{index}`

#### 1.2 ç´¢å¼•åˆ†é…è§„åˆ™
- **å¹³å°ä¿ç•™ç´¢å¼•**: 0-1000 (ç´¢å¼• 0-1000 ä¿ç•™ç»™å¹³å°å†…éƒ¨ä½¿ç”¨)
- **ç”¨æˆ·èµ·å§‹ç´¢å¼•**: **1001** (æ–°ç”¨æˆ·ä»ç´¢å¼• 1001 å¼€å§‹åˆ†é…)
- **åˆ†é…é€»è¾‘**: 
  - æ³¨å†Œæ—¶è°ƒç”¨ `KmsService.getNewDepositWallets()`
  - æŸ¥è¯¢æ•°æ®åº“ä¸­ `deposit_path_index` çš„æœ€å¤§å€¼
  - æ–°ç´¢å¼• = `MAX(æœ€å¤§ç´¢å¼• + 1, 1001)`
  - åŒæ—¶ç”Ÿæˆ EVM å’Œ TRON ä¸¤ä¸ªåœ°å€

#### 1.3 åœ°å€å­˜å‚¨
- ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œ`deposit_path_index`ã€`evm_deposit_address`ã€`tron_deposit_address` å†™å…¥ `users` è¡¨
- ç§é’¥ä¸å­˜å‚¨ï¼Œéœ€è¦æ—¶é€šè¿‡ `KmsService.getPrivateKey(chainType, index)` åŠ¨æ€æ´¾ç”Ÿ

### 2. ç”¨æˆ·å……å€¼ç›‘å¬æœºåˆ¶

#### 2.1 ç›‘å¬æ–¹å¼
- **æœåŠ¡**: `TronListener.js`
- **ç›‘å¬é¢‘ç‡**: **æ¯ 10 ç§’è½®è¯¢ä¸€æ¬¡** (`POLLING_INTERVAL_MS = 10000`)
- **ç›‘å¬èŒƒå›´**: æ‰€æœ‰å·²æ³¨å†Œç”¨æˆ·çš„ TRON å……å€¼åœ°å€

#### 2.2 ç›‘å¬å†…å®¹
1. **TRC20-USDT å……å€¼**:
   - API: `v1/accounts/{address}/transactions/trc20`
   - è¿‡æ»¤æ¡ä»¶: `only_to=true`, `only_confirmed=true`, `contract_address=USDT_CONTRACT`
   - USDT åˆçº¦åœ°å€ (Nile æµ‹è¯•ç½‘): `TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs`

2. **TRX äº¤æ˜“è®°å½•**:
   - API: `v1/accounts/{address}/transactions`
   - è¿‡æ»¤æ¡ä»¶: `only_to=true`, `only_confirmed=true`, `TransferContract` ç±»å‹
   - ç”¨é€”: ä»…è®°å½•ç”¨æˆ·æ”¶åˆ° TRX çš„äº¤æ˜“ï¼ˆç±»å‹ä¸º `deposit_trx`ï¼‰
   - **æ³¨æ„**: 
     - ä»…è®°å½•åˆ° `platform_transactions` è¡¨ï¼Œ**ä¸ä¼šæ›´æ–°ç”¨æˆ·ä½™é¢**
     - **ä¸ä¼šè‡ªåŠ¨æ¿€æ´»åœ°å€**ï¼Œç”¨æˆ·éœ€è¦è‡ªè¡Œæ¿€æ´»æˆ–é€šè¿‡å…¶ä»–æ–¹å¼æ¿€æ´»
     - ä¸»è¦ç”¨äºäº¤æ˜“å†å²è®°å½•å’Œå®¡è®¡

#### 2.3 å¤„ç†æµç¨‹
1. è½®è¯¢æ‰€æœ‰ç”¨æˆ·çš„ `tron_deposit_address`
2. æŸ¥è¯¢æ¯ä¸ªåœ°å€çš„æœ€è¿‘äº¤æ˜“ï¼ˆåŸºäºæ—¶é—´æˆ³å¢é‡æŸ¥è¯¢ï¼‰
3. æ£€æŸ¥äº¤æ˜“æ˜¯å¦å·²å¤„ç†ï¼ˆæŸ¥è¯¢ `platform_transactions` è¡¨ï¼‰
4. å¤„ç†æ–°äº¤æ˜“:
   - **TRC20-USDT å……å€¼**:
     - æ›´æ–°ç”¨æˆ·ä½™é¢ (`users.balance`)
     - è®°å½•äº¤æ˜“æµæ°´ (`platform_transactions`, ç±»å‹: `deposit`)
     - è®°å½•è´¦å˜ (`balance_changes`)
     - é€šè¿‡ Socket.IO å®æ—¶é€šçŸ¥ç”¨æˆ·
   - **TRX äº¤æ˜“**:
     - ä»…è®°å½•äº¤æ˜“æµæ°´ (`platform_transactions`, ç±»å‹: `deposit_trx`)
     - **ä¸æ›´æ–°ç”¨æˆ·ä½™é¢**ï¼ˆTRX ä¸æ˜¯å¹³å°æ”¯æŒçš„å……å€¼å¸ç§ï¼‰
     - **ä¸æ¿€æ´»åœ°å€**ï¼ˆç³»ç»Ÿä¸å†è‡ªåŠ¨æ¿€æ´»ï¼‰

#### 2.4 æ—¶é—´æˆ³ç®¡ç†
- ä½¿ç”¨ `lastTrc20PollTimestamp` å’Œ `lastTrxPollTimestamp` è¿½è¸ªå·²æŸ¥è¯¢çš„æ—¶é—´ç‚¹
- æ¯æ¬¡è½®è¯¢åæ›´æ–°æ—¶é—´æˆ³ï¼ˆ+1ms é¿å…é‡å¤ï¼‰
- åˆå§‹æŸ¥è¯¢èŒƒå›´: è¿‡å» 10 åˆ†é’Ÿ

### 3. ç”¨æˆ·å……å€¼åœ°å€å½’é›†æœºåˆ¶

#### 3.1 å½’é›†æ–¹å¼
- **æœåŠ¡**: `TronCollectionService.js`
- **å½’é›†æ¨¡å¼**: **Approve + TransferFrom** (åŒç­¾åæ¨¡å¼)
  - ç”¨æˆ·åœ°å€æ‰§è¡Œ `approve()`: æˆæƒå½’é›†é’±åŒ…å¯è½¬å‡º USDTï¼ˆä¸æ¶ˆè€—èƒ½é‡å’Œ TRXï¼‰
  - å½’é›†é’±åŒ…æ‰§è¡Œ `transferFrom()`: å®é™…è½¬å‡º USDTï¼ˆæ¶ˆè€—èƒ½é‡ï¼‰

#### 3.2 å½’é›†é’±åŒ…é…ç½®
- **å½’é›†é’±åŒ…**: ä» `platform_wallets` è¡¨è¯»å– `is_collection=true` çš„é’±åŒ…
- **æ³¨æ„**: ç³»ç»Ÿä¸å†è‡ªåŠ¨æ¿€æ´»ç”¨æˆ·åœ°å€ï¼Œç”¨æˆ·éœ€è¦è‡ªè¡Œæ¿€æ´»æˆ–é€šè¿‡å…¶ä»–æ–¹å¼æ¿€æ´»åœ°å€

#### 3.3 å½’é›†è§¦å‘æ¡ä»¶
1. **æ‰«æé—´éš”**: ç”± `collection_settings.scan_interval_days` æ§åˆ¶ï¼ˆé»˜è®¤æŒ‰å¤©æ‰«æï¼‰
2. **å½’é›†æ¡ä»¶** (éœ€åŒæ—¶æ»¡è¶³):
   - ç”¨æˆ· USDT ä½™é¢ > 0
   - è·ç¦»ä¸Šæ¬¡å……å€¼æ—¶é—´ >= `days_without_deposit` å¤©
   - æˆ–ç”¨æˆ·åˆ›å»ºæ—¶é—´ >= `days_without_deposit` å¤©ï¼ˆæ— å……å€¼è®°å½•æ—¶ï¼‰
   - æ—  pending çŠ¶æ€çš„å½’é›†è®°å½•

#### 3.4 å½’é›†æ‰§è¡Œæµç¨‹
1. **æ£€æŸ¥æ‰«æé—´éš”**: æŸ¥è¯¢ `collection_cursor` è¡¨ï¼Œåˆ¤æ–­æ˜¯å¦åˆ°è¾¾æ‰«ææ—¶é—´
2. **èƒ½é‡ç®¡ç†**:
   - è·å–å½’é›†é’±åŒ…å½“å‰èƒ½é‡
   - è®¡ç®—å¹³å‡èƒ½é‡æ¶ˆè€—ï¼ˆä»å†å² `collection_logs` ç»Ÿè®¡ï¼Œé»˜è®¤ 35000ï¼‰
   - ä¼°ç®—å¯å¤„ç†åœ°å€æ•°é‡ = `å½“å‰èƒ½é‡ / å¹³å‡èƒ½é‡æ¶ˆè€—`
3. **æ‰¹é‡å¤„ç†**:
   - æŒ‰ `user_id` é¡ºåºæŸ¥è¯¢ç”¨æˆ·ï¼ˆæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼‰
   - æ£€æŸ¥æ¯ä¸ªç”¨æˆ·æ˜¯å¦ç¬¦åˆå½’é›†æ¡ä»¶
   - æ£€æŸ¥å¹¶æ‰§è¡Œ `approve()`ï¼ˆå¦‚æœ allowance < balanceï¼‰
   - æ‰§è¡Œ `transferFrom()` å½’é›†
   - è®°å½•å½’é›†æ—¥å¿—åˆ° `collection_logs` è¡¨
   - **æ³¨æ„**: ç³»ç»Ÿä¸å†è‡ªåŠ¨æ¿€æ´»ç”¨æˆ·åœ°å€ï¼Œæœªæ¿€æ´»çš„åœ°å€å°†æ— æ³•å½’é›†
4. **æ–­ç‚¹ç»­ä¼ **: ä½¿ç”¨ `collection_cursor` è®°å½•æœ€åå¤„ç†çš„ `user_id`ï¼Œä¸‹æ¬¡ä»è¯¥ä½ç½®ç»§ç»­

#### 3.5 èƒ½é‡æ¶ˆè€—
- **å½’é›†é’±åŒ…**: æ¶ˆè€—è‡ªå·±çš„èƒ½é‡æ‰§è¡Œ `transferFrom()`
- **ç”¨æˆ·åœ°å€**: `approve()` ä¸æ¶ˆè€—èƒ½é‡å’Œ TRXï¼ˆç”±ç”¨æˆ·åœ°å€ç­¾åï¼Œä½†è´¹ç”¨ä¸º 0ï¼‰
- **èƒ½é‡æ¥æº**: å½’é›†é’±åŒ…éœ€è¦è´¨æŠ¼ TRX æˆ–è´­ä¹°èƒ½é‡

### 4. è‡ªåŠ¨å‡ºæ¬¾æœºåˆ¶

#### 4.1 å‡ºæ¬¾é’±åŒ…
- **å‡ºæ¬¾é’±åŒ…**: ä» `platform_wallets` è¡¨è¯»å– `is_payout=true` çš„é’±åŒ…
- **ç§é’¥é…ç½®**: é€šè¿‡ç¯å¢ƒå˜é‡ `TRON_PK_{address}` é…ç½®
- **å‡ºæ¬¾æ–¹å¼**: ç›´æ¥æ‰§è¡Œ TRC20-USDT `transfer()` äº¤æ˜“

#### 4.2 è‡ªåŠ¨å‡ºæ¬¾è§¦å‘æ¡ä»¶
éœ€åŒæ—¶æ»¡è¶³ä»¥ä¸‹æ¡ä»¶:
1. **ç³»ç»Ÿè®¾ç½®**: `AUTO_WITHDRAW_THRESHOLD > 0` (åœ¨ `system_settings` è¡¨ä¸­é…ç½®)
2. **é‡‘é¢é™åˆ¶**: ææ¬¾é‡‘é¢ <= `AUTO_WITHDRAW_THRESHOLD`
3. **é“¾ç±»å‹**: `chain_type = 'TRC20'` (ç›®å‰ä»…æ”¯æŒ TRC20)
4. **æœåŠ¡å°±ç»ª**: `PayoutService` å·²åˆå§‹åŒ–ä¸”é’±åŒ…å·²åŠ è½½

#### 4.3 å‡ºæ¬¾æµç¨‹
1. **ç”¨æˆ·æäº¤ææ¬¾è¯·æ±‚**:
   - éªŒè¯ææ¬¾å¯†ç 
   - æ£€æŸ¥ä½™é¢æ˜¯å¦å……è¶³
   - æ‰£é™¤ç”¨æˆ·ä½™é¢
   - åˆ›å»º `withdrawals` è®°å½•

2. **åˆ¤æ–­æ˜¯å¦è‡ªåŠ¨å‡ºæ¬¾**:
   - ç¬¦åˆæ¡ä»¶ â†’ `status = 'processing'`ï¼Œå¼‚æ­¥æ‰§è¡Œé“¾ä¸Šå‡ºæ¬¾
   - ä¸ç¬¦åˆæ¡ä»¶ â†’ `status = 'pending'`ï¼Œç­‰å¾…äººå·¥å®¡æ ¸

3. **è‡ªåŠ¨å‡ºæ¬¾æ‰§è¡Œ** (å¼‚æ­¥):
   - è°ƒç”¨ `PayoutService.sendTrc20Payout()`
   - æ„å»ºå¹¶ç­¾å TRC20-USDT `transfer()` äº¤æ˜“
   - å¹¿æ’­äº¤æ˜“åˆ°é“¾ä¸Š
   - æ›´æ–° `withdrawals.status = 'completed'` å¹¶è®°å½• `tx_hash`
   - å¦‚æœå¤±è´¥ï¼Œå›é€€çŠ¶æ€ä¸º `pending`ï¼Œç­‰å¾…äººå·¥å®¡æ ¸

#### 4.4 äº¤æ˜“è´¹ç”¨
- **Gas è´¹ç”¨**: è‡ªåŠ¨å‡ºæ¬¾ä½¿ç”¨ TRX ä½œä¸º Gasï¼ˆä¸æ¶ˆè€—èƒ½é‡ï¼‰
- **è´¹ç”¨é™é¢**: `feeLimit = 15000000` (15 TRX)
- **è´¹ç”¨æ¥æº**: å‡ºæ¬¾é’±åŒ…éœ€æŒæœ‰è¶³å¤Ÿçš„ TRX

### 5. è´¨æŠ¼èƒ½é‡ä¸äº¤æ˜“è´¹ç”¨

#### 5.1 èƒ½é‡ä½¿ç”¨åœºæ™¯
1. **å½’é›†äº¤æ˜“** (`transferFrom`):
   - å½’é›†é’±åŒ…æ¶ˆè€—è‡ªå·±çš„èƒ½é‡
   - å¹³å‡æ¶ˆè€—: ~35000 èƒ½é‡/ç¬”
   - èƒ½é‡æ¥æº: å½’é›†é’±åŒ…è´¨æŠ¼ TRX æˆ–è´­ä¹°èƒ½é‡

2. **ç”¨æˆ·åœ°å€æ¿€æ´»**:
   - Gas å‚¨å¤‡é’±åŒ…è½¬ 1 TRX ç»™ç”¨æˆ·åœ°å€
   - æ¶ˆè€— TRXï¼ˆéèƒ½é‡ï¼‰

#### 5.2 TRX ä½¿ç”¨åœºæ™¯
1. **è‡ªåŠ¨å‡ºæ¬¾** (`transfer`):
   - å‡ºæ¬¾é’±åŒ…æ¶ˆè€— TRX ä½œä¸º Gas
   - è´¹ç”¨é™é¢: 15 TRX/ç¬”

2. **åœ°å€æ¿€æ´»**:
   - **æ³¨æ„**: ç³»ç»Ÿä¸å†è‡ªåŠ¨æ¿€æ´»ç”¨æˆ·åœ°å€ï¼Œç”¨æˆ·éœ€è¦è‡ªè¡Œæ¿€æ´»æˆ–é€šè¿‡å…¶ä»–æ–¹å¼æ¿€æ´»

#### 5.3 é’±åŒ…è§’è‰²åˆ†å·¥
- **å½’é›†é’±åŒ…** (`is_collection=true`): æ‰§è¡Œå½’é›†ï¼Œæ¶ˆè€—èƒ½é‡
- **å‡ºæ¬¾é’±åŒ…** (`is_payout=true`): æ‰§è¡Œè‡ªåŠ¨å‡ºæ¬¾ï¼Œæ¶ˆè€— TRX
- **æ³¨æ„**: `Gas å‚¨å¤‡é’±åŒ…` åŠŸèƒ½å·²ç§»é™¤ï¼Œç³»ç»Ÿä¸å†è‡ªåŠ¨æ¿€æ´»ç”¨æˆ·åœ°å€

### 6. æ½œåœ¨ç¼ºé™·ä¸æ”¹è¿›å»ºè®®

#### 6.1 å……å€¼ç›‘å¬
- âš ï¸ **ç¼ºé™·**: è½®è¯¢é¢‘ç‡å›ºå®š 10 ç§’ï¼Œé«˜å³°æœŸå¯èƒ½å»¶è¿Ÿ
  - **å»ºè®®**: è€ƒè™‘ä½¿ç”¨ WebSocket äº‹ä»¶ç›‘å¬ï¼ˆå¦‚æœèŠ‚ç‚¹æ”¯æŒï¼‰
- âš ï¸ **ç¼ºé™·**: ä»…ç›‘å¬ TRON é“¾ï¼ŒEVM é“¾ï¼ˆBSC/ETH/Polygonï¼‰æœªå®ç°
  - **å»ºè®®**: å®ç° EVM é“¾çš„ç›‘å¬æœåŠ¡
- âš ï¸ **ç¼ºé™·**: æ—¶é—´æˆ³ç®¡ç†å¯èƒ½å› æœåŠ¡é‡å¯ä¸¢å¤±
  - **å»ºè®®**: å°†æ—¶é—´æˆ³æŒä¹…åŒ–åˆ°æ•°æ®åº“

#### 6.2 å½’é›†æœºåˆ¶
- âš ï¸ **ç¼ºé™·**: èƒ½é‡ä¸è¶³æ—¶åœæ­¢å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´éƒ¨åˆ†ç”¨æˆ·é•¿æœŸæœªå½’é›†
  - **å»ºè®®**: å®ç°èƒ½é‡ç›‘æ§å’Œè‡ªåŠ¨è¡¥å……æœºåˆ¶
- âš ï¸ **ç¼ºé™·**: `approve()` å¤±è´¥æ—¶è·³è¿‡ç”¨æˆ·ï¼Œæ— é‡è¯•æœºåˆ¶
  - **å»ºè®®**: å®ç°å¤±è´¥é‡è¯•é˜Ÿåˆ—
- âš ï¸ **ç¼ºé™·**: æ‰«æé—´éš”å›ºå®šï¼Œæ— æ³•æ ¹æ®ä¸šåŠ¡éœ€æ±‚åŠ¨æ€è°ƒæ•´
  - **å»ºè®®**: æ”¯æŒæŒ‰ç”¨æˆ·ç­‰çº§æˆ–ä½™é¢è®¾ç½®ä¸åŒçš„å½’é›†ç­–ç•¥

#### 6.3 è‡ªåŠ¨å‡ºæ¬¾
- âš ï¸ **ç¼ºé™·**: ä»…æ”¯æŒ TRC20ï¼Œå…¶ä»–é“¾æœªå®ç°
  - **å»ºè®®**: å®ç° BSC/ETH/Polygon çš„è‡ªåŠ¨å‡ºæ¬¾
- âš ï¸ **ç¼ºé™·**: å‡ºæ¬¾å¤±è´¥åå›é€€ä¸ºäººå·¥å®¡æ ¸ï¼Œæ— è‡ªåŠ¨é‡è¯•
  - **å»ºè®®**: å®ç°å¤±è´¥é‡è¯•æœºåˆ¶ï¼ˆå¦‚ä½™é¢ä¸è¶³æ—¶ç­‰å¾…å……å€¼åé‡è¯•ï¼‰
- âš ï¸ **ç¼ºé™·**: æ— å‡ºæ¬¾é’±åŒ…ä½™é¢ç›‘æ§
  - **å»ºè®®**: å®ç°ä½™é¢ç›‘æ§å’Œä½ä½™é¢å‘Šè­¦

#### 6.4 åœ°å€åˆ†é…
- âš ï¸ **ç¼ºé™·**: ç´¢å¼•åˆ†é…æ— å¹¶å‘æ§åˆ¶ï¼Œé«˜å¹¶å‘æ³¨å†Œå¯èƒ½åˆ†é…é‡å¤ç´¢å¼•
  - **å»ºè®®**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡å’Œé”æœºåˆ¶ç¡®ä¿ç´¢å¼•å”¯ä¸€æ€§
- âš ï¸ **ç¼ºé™·**: å¹³å°ä¿ç•™ç´¢å¼•èŒƒå›´ï¼ˆ0-1000ï¼‰ç¡¬ç¼–ç ï¼Œæ— æ³•é…ç½®
  - **å»ºè®®**: å°†ä¿ç•™èŒƒå›´é…ç½®åŒ–

#### 6.5 å®‰å…¨æ€§
- âš ï¸ **ç¼ºé™·**: ä¸»å¯†é’¥ (`MASTER_MNEMONIC`) å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡ï¼Œéœ€ç¡®ä¿å®‰å…¨
  - **å»ºè®®**: ä½¿ç”¨å¯†é’¥ç®¡ç†æœåŠ¡ï¼ˆKMSï¼‰æˆ–ç¡¬ä»¶å®‰å…¨æ¨¡å—ï¼ˆHSMï¼‰
- âš ï¸ **ç¼ºé™·**: ç§é’¥åœ¨å†…å­˜ä¸­åŠ¨æ€æ´¾ç”Ÿï¼Œéœ€ç¡®ä¿æœåŠ¡è¿›ç¨‹å®‰å…¨
  - **å»ºè®®**: å®ç°ç§é’¥åŠ å¯†å­˜å‚¨å’Œè®¿é—®æ§åˆ¶

#### 6.6 ç›‘æ§ä¸å‘Šè­¦
- âš ï¸ **ç¼ºé™·**: ç¼ºä¹å…³é”®æŒ‡æ ‡ç›‘æ§ï¼ˆå……å€¼å»¶è¿Ÿã€å½’é›†æˆåŠŸç‡ã€å‡ºæ¬¾å¤±è´¥ç‡ï¼‰
  - **å»ºè®®**: é›†æˆç›‘æ§ç³»ç»Ÿï¼ˆå¦‚ Prometheus + Grafanaï¼‰
- âš ï¸ **ç¼ºé™·**: æ— å¼‚å¸¸å‘Šè­¦æœºåˆ¶
  - **å»ºè®®**: å®ç°é‚®ä»¶/çŸ­ä¿¡/Webhook å‘Šè­¦

## ğŸ”’ å®‰å…¨ç‰¹æ€§

- âœ… IP ç™½åå•ï¼ˆåå°ç®¡ç†ï¼‰
- âœ… é€Ÿç‡é™åˆ¶
- âœ… å¯†ç åŠ å¯†ï¼ˆbcryptï¼‰
- âœ… JWT èº«ä»½éªŒè¯
- âœ… è°·æ­ŒäºŒæ¬¡éªŒè¯ï¼ˆ2FAï¼‰
- âœ… é£æ§ç³»ç»Ÿ
- âœ… å®¡è®¡æ—¥å¿—

## ğŸ“ å¼€å‘è§„èŒƒ

æœ¬é¡¹ç›®ä¸¥æ ¼éµå¾ª **PROJECT_CONSTITUTION.md** çš„å¼€å‘è§„èŒƒï¼š

- âœ… æ¶æ„åˆ†ç¦»ï¼ˆå‰ç«¯/åç«¯ï¼‰
- âœ… API ç»Ÿä¸€æ ¼å¼
- âœ… ç»„ä»¶ä¸è¶…è¿‡ 300 è¡Œ
- âœ… ä½¿ç”¨ Design System tokens
- âœ… è§†è§‰å¯†åº¦ç³»ç»Ÿ
- âœ… RWD å“åº”å¼è§„èŒƒ

è¯¦ç»†è§„èŒƒè¯·å‚è€ƒ [PROJECT_CONSTITUTION.md](./PROJECT_CONSTITUTION.md)

## ğŸ”§ å¼€å‘æ¨¡å¼

### å‰ç«¯å¼€å‘

```bash
cd apps/web
npm install
npm run dev
```

### åç«¯å¼€å‘

```bash
cd apps/backend-legacy
npm install
npm start
```

### æ•°æ®åº“è¿ç§»

```bash
# ä½¿ç”¨ Node.js è„šæœ¬
cd apps/backend-legacy
node scripts/run-migration.js <migration-file.sql>

# æˆ–ç›´æ¥ä½¿ç”¨ Docker
docker exec -i flipcoin-db psql -U game_user -d flipcoin_db < packages/database/migrations/<migration-file.sql>
```

## ğŸ“š æ–‡æ¡£

- [é¡¹ç›®å®ªæ³•](./PROJECT_CONSTITUTION.md) - å¼€å‘è§„èŒƒ
- [å˜æ›´æ—¥å¿—](./CHANGELOG.md) - ç‰ˆæœ¬å˜æ›´è®°å½•
- [å‰ç«¯éƒ¨ç½²æŒ‡å—](./apps/web/DEPLOYMENT.md) - å‰ç«¯éƒ¨ç½²è¯´æ˜
- [å¤šè¯­ç³»è®¾ç½®](./apps/web/I18N_SETUP.md) - å¤šè¯­ç³»é…ç½®æŒ‡å—

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡**: ç¡®ä¿æ­£ç¡®é…ç½® `.env` æ–‡ä»¶
2. **æ•°æ®åº“**: é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨æ‰§è¡Œ `init.sql` åˆå§‹åŒ–æ•°æ®åº“
3. **ç«¯å£**: é»˜è®¤ä½¿ç”¨ 8080 ç«¯å£ï¼Œå¯åœ¨ `.env` ä¸­ä¿®æ”¹
4. **ç”Ÿäº§ç¯å¢ƒ**: éƒ¨ç½²å‰è¯·ä¿®æ”¹é»˜è®¤å¯†ç å’Œå¯†é’¥

## ğŸ“„ è®¸å¯è¯

[å¾…è¡¥å……]
